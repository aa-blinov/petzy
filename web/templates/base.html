<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Petzy">
    <meta name="theme-color" content="#0A84FF">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.svg') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='icon-192.svg') }}">
    <title>{% block title %}Petzy{% endblock %}</title>
    <!-- Framework7 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8/css/framework7.bundle.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=5">
    <script>
        // Token refresh logic
        let isRefreshing = false;
        
        async function refreshAccessToken() {
            if (isRefreshing) {
                // Wait for ongoing refresh
                return new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        if (!isRefreshing) {
                            clearInterval(checkInterval);
                            resolve(true);
                        }
                    }, 100);
                });
            }
            
            isRefreshing = true;
            try {
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    isRefreshing = false;
                    return true;
                } else {
                    // Refresh token expired, redirect to login
                    isRefreshing = false;
                    window.location.href = '/login';
                    return false;
                }
            } catch (error) {
                console.error('Token refresh error:', error);
                isRefreshing = false;
                window.location.href = '/login';
                return false;
            }
        }
        
        // Intercept fetch requests to handle token refresh
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            let response = await originalFetch(...args);
            
            // If token expired, try to refresh
            if (response.status === 401) {
                const data = await response.json().catch(() => ({}));
                if (data.refresh_required) {
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        // Retry original request
                        response = await originalFetch(...args);
                    }
                } else {
                    // Not a token refresh issue, redirect to login
                    window.location.href = '/login';
                }
            }
            
            return response;
        };
    </script>
    {% block extra_head %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">üêæ Petzy</h1>
            {% block nav_user %}
            <div class="nav-user">
                <button class="btn btn-secondary btn-small nav-btn" onclick="showScreen('settings')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
                <div id="pet-switcher" class="pet-switcher">
                    <button class="btn btn-secondary btn-small nav-btn" id="pet-switcher-btn" onclick="showPetSwitcherMenu()">
                        <span id="pet-switcher-name">–í—ã–±—Ä–∞—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ</span> ‚ñº
                    </button>
                    <div id="pet-switcher-menu" class="pet-switcher-menu" style="display: none;">
                        <div id="pet-switcher-list"></div>
                        <div class="pet-switcher-divider"></div>
                        <button class="btn btn-primary btn-small btn-block" onclick="showScreen('pet-selector'); hidePetSwitcherMenu();">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–º–∏</button>
                    </div>
                </div>
                <span id="nav-username">Admin</span>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-small nav-btn" onclick="event.preventDefault(); if (typeof UsersModule !== 'undefined') UsersModule.clearAdminCache(); fetch('/api/auth/logout', {method: 'POST', credentials: 'include'}).then(() => window.location.href='/login');">–í—ã–π—Ç–∏</a>
            </div>
            {% endblock %}
        </div>
    </nav>
    
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Framework7 JS -->
    <script src="https://cdn.jsdelivr.net/npm/framework7@8/js/framework7.bundle.min.js"></script>
    <!-- Application Modules -->
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pets.js') }}"></script>
    <script src="{{ url_for('static', filename='js/users.js') }}"></script>
    <script src="{{ url_for('static', filename='js/history.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navigation.js') }}"></script>
    <!-- Forms Configuration -->
    <script src="{{ url_for('static', filename='js/forms-config.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>

