{% extends "base.html" %}

{% block title %}Petzy{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Main Menu -->
    <div id="main-menu" class="screen active">
        <div class="action-cards">
            <div class="card action-card action-card-feeding" onclick="showScreen('feeding-form')">
                <h3>–î–Ω–µ–≤–Ω–∞—è –ø–æ—Ä—Ü–∏—è –∫–æ—Ä–º–∞</h3>
                <p>–ó–∞–ø–∏—Å–∞—Ç—å –ø–æ—Ä—Ü–∏—é</p>
            </div>
            
            <div class="card action-card action-card-weight" onclick="showScreen('weight-form')">
                <h3>–í–µ—Å</h3>
                <p>–ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å</p>
            </div>
            
            <div class="card action-card action-card-asthma" onclick="showScreen('asthma-form')">
                <h3>–ü—Ä–∏—Å—Ç—É–ø –∞—Å—Ç–º—ã</h3>
                <p>–ó–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏—Å—Ç—É–ø</p>
            </div>
            
            <div class="card action-card action-card-defecation" onclick="showScreen('defecation-form')">
                <h3>–î–µ—Ñ–µ–∫–∞—Ü–∏—è</h3>
                <p>–ó–∞–ø–∏—Å–∞—Ç—å –¥–µ—Ñ–µ–∫–∞—Ü–∏—é</p>
            </div>
            
            <div class="card action-card action-card-litter" onclick="showScreen('litter-form')">
                <h3>–°–º–µ–Ω–∞ –ª–æ—Ç–∫–∞</h3>
                <p>–ó–∞–ø–∏—Å–∞—Ç—å —Å–º–µ–Ω—É –ª–æ—Ç–∫–∞</p>
            </div>
            
            <div class="card action-card action-card-history" onclick="showScreen('history')">
                <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π</p>
            </div>
            
            <div class="card action-card action-card-admin admin-link" onclick="showScreen('admin-panel')" style="display: none;">
                <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</p>
            </div>
        </div>
    </div>
    
    <!-- Feeding Form -->
    <div id="feeding-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ó–∞–ø–∏—Å–∞—Ç—å –¥–Ω–µ–≤–Ω—É—é –ø–æ—Ä—Ü–∏—é –∫–æ—Ä–º–∞</h2>
        </div>
        <div id="feeding-form-container"></div>
    </div>
    
    <!-- Asthma Form -->
    <div id="asthma-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ó–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏—Å—Ç—É–ø –∞—Å—Ç–º—ã</h2>
        </div>
        <div id="asthma-form-container"></div>
    </div>
    
    <!-- Defecation Form -->
    <div id="defecation-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ó–∞–ø–∏—Å–∞—Ç—å –¥–µ—Ñ–µ–∫–∞—Ü–∏—é</h2>
        </div>
        <div id="defecation-form-container"></div>
    </div>
    
    <!-- Litter Change Form -->
    <div id="litter-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ó–∞–ø–∏—Å–∞—Ç—å —Å–º–µ–Ω—É –ª–æ—Ç–∫–∞</h2>
        </div>
        <div id="litter-form-container"></div>
    </div>
    
    <!-- Weight Form -->
    <div id="weight-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å</h2>
        </div>
        <div id="weight-form-container"></div>
    </div>
    
    <!-- Settings Screen -->
    <div id="settings" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</h2>
        </div>
        <form id="settings-form" class="inline-form">
            <div class="form-content">
                <div class="settings-section">
                    <h3>–ü—Ä–∏—Å—Ç—É–ø –∞—Å—Ç–º—ã</h3>
                    <div class="form-group">
                        <label for="default-asthma-duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                        <select id="default-asthma-duration" name="default_asthma_duration">
                            <option value="–ö–æ—Ä–æ—Ç–∫–∏–π">–ö–æ—Ä–æ—Ç–∫–∏–π</option>
                            <option value="–î–ª–∏—Ç–µ–ª—å–Ω—ã–π">–î–ª–∏—Ç–µ–ª—å–Ω—ã–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-asthma-inhalation">–ò–Ω–≥–∞–ª—è—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                        <select id="default-asthma-inhalation" name="default_asthma_inhalation">
                            <option value="false">–ù–µ—Ç</option>
                            <option value="true">–î–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-asthma-reason">–ü—Ä–∏—á–∏–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                        <input type="text" id="default-asthma-reason" name="default_asthma_reason" placeholder="–ü–∏–ª">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>–î–µ—Ñ–µ–∫–∞—Ü–∏—è</h3>
                    <div class="form-group">
                        <label for="default-defecation-stool-type">–¢–∏–ø —Å—Ç—É–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                        <select id="default-defecation-stool-type" name="default_defecation_stool_type">
                            <option value="–û–±—ã—á–Ω—ã–π">–û–±—ã—á–Ω—ã–π</option>
                            <option value="–¢–≤–µ—Ä–¥—ã–π">–¢–≤–µ—Ä–¥—ã–π</option>
                            <option value="–ñ–∏–¥–∫–∏–π">–ñ–∏–¥–∫–∏–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-defecation-color">–¶–≤–µ—Ç —Å—Ç—É–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                        <select id="default-defecation-color" name="default_defecation_color">
                            <option value="–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π">–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                            <option value="–¢–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π">–¢–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                            <option value="–°–≤–µ—Ç–ª–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π">–°–≤–µ—Ç–ª–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                            <option value="–î—Ä—É–≥–æ–π">–î—Ä—É–≥–æ–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-defecation-food">–ö–æ—Ä–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                        <input type="text" id="default-defecation-food" name="default_defecation_food" placeholder="Royal Canin Fibre Response">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>–í–µ—Å</h3>
                    <div class="form-group">
                        <label for="default-weight-food">–ö–æ—Ä–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                        <input type="text" id="default-weight-food" name="default_weight_food" placeholder="Royal Canin Fibre Response">
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="resetSettingsToDefaults()">–°–±—Ä–æ—Å–∏—Ç—å –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
            </div>
        </form>
    </div>
    
    <!-- Pet Selector Screen -->
    <div id="pet-selector" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–∞–º–∏</h2>
        </div>
        <div class="inline-form">
            <div class="form-content">
                <div id="pets-list" class="pets-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary btn-block" onclick="resetPetForm(); showScreen('pet-form');">+ –î–æ–±–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞</button>
            </div>
        </div>
    </div>
    
    <!-- Pet Form Screen -->
    <div id="pet-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('pet-selector')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2 id="pet-form-title">–î–æ–±–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞</h2>
        </div>
        <form id="pet-form-element" class="inline-form">
            <input type="hidden" id="pet-record-id" name="pet_id" value="">
            <div class="form-content">
                <div class="form-group">
                    <label for="pet-name">–ò–º—è *</label>
                    <input type="text" id="pet-name" name="name" required placeholder="–°–∞–π–º–æ–Ω">
                </div>
                <div class="form-group">
                    <label for="pet-breed">–ü–æ—Ä–æ–¥–∞</label>
                    <input type="text" id="pet-breed" name="breed" placeholder="–ë—Ä–∏—Ç–∞–Ω—Å–∫–∞—è –∫–æ—Ä–æ—Ç–∫–æ—à–µ—Ä—Å—Ç–Ω–∞—è">
                </div>
                <div class="form-group">
                    <label for="pet-birth-date">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" id="pet-birth-date" name="birth_date">
                </div>
                <div class="form-group">
                    <label for="pet-gender">–ü–æ–ª</label>
                    <select id="pet-gender" name="gender">
                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>
                        <option value="–ú–∞–ª—å—á–∏–∫">–ú–∞–ª—å—á–∏–∫</option>
                        <option value="–î–µ–≤–æ—á–∫–∞">–î–µ–≤–æ—á–∫–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pet-photo-file">–§–æ—Ç–æ –ø–∏—Ç–æ–º—Ü–∞</label>
                    <input type="file" id="pet-photo-file" name="photo_file" accept="image/*">
                    <div id="pet-photo-preview" class="photo-preview-section" style="display: none;">
                        <img id="pet-photo-preview-img" src="" alt="Preview">
                        <button type="button" class="btn btn-secondary btn-small" onclick="clearPetPhoto()">–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>
                    </div>
                    <div id="pet-photo-current" class="photo-current-section" style="display: none;">
                        <h4>–¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ</h4>
                        <img id="pet-photo-current-img" src="" alt="Current">
                    </div>
                </div>
                
                <!-- Access Management Section (only when editing) -->
                <div id="pet-access-section" class="sharing-section" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 0.5px solid var(--ios-separator);">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º</h3>
                    <div id="pet-shared-with-list" class="shared-list">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="share-username-input">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</label>
                        <div class="share-input-group">
                            <input type="text" id="share-username-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                            <button type="button" class="btn btn-primary" onclick="sharePetFromForm()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block" id="pet-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="showScreen('pet-selector')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
    
    <!-- Admin Panel Screen -->
    <div id="admin-panel" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        </div>
        <div class="admin-content">
            <div class="admin-section">
                <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <button class="btn btn-primary btn-block" onclick="resetUserForm(); showScreen('user-form');">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                <div id="users-list" class="users-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Form Screen -->
    <div id="user-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('admin-panel')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2 id="user-form-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        </div>
        <form id="user-form-element" class="inline-form">
            <input type="hidden" id="user-record-username" name="username" value="">
            <div class="form-group">
                <label for="user-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
                <input type="text" id="user-username" name="username" required placeholder="user123">
            </div>
            <div class="form-group">
                <label for="user-password" id="user-password-label">–ü–∞—Ä–æ–ª—å *</label>
                <input type="password" id="user-password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <div class="form-group">
                <label for="user-full-name">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                <input type="text" id="user-full-name" name="full_name" placeholder="–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞">
            </div>
            <div class="form-group">
                <label for="user-email">Email</label>
                <input type="email" id="user-email" name="email" placeholder="email@example.com">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block" id="user-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="showScreen('admin-panel')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
    
    <!-- Pet Sharing Screen -->
    <div id="pet-sharing" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('pet-selector')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–î–æ—Å—Ç—É–ø –∫ –∂–∏–≤–æ—Ç–Ω–æ–º—É</h2>
        </div>
        <div class="sharing-content">
            <div id="sharing-info" class="sharing-section">
                <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º</h3>
                <div id="shared-with-list" class="shared-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div id="sharing-owner-section" class="sharing-section" style="display: none;">
                <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h3>
                <form id="share-form" class="inline-form">
                    <div class="form-group">
                        <label for="share-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="share-username" name="username" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-block">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                    </div>
                </form>
            </div>
            
            <div id="sharing-user-section" class="sharing-section" style="display: none;">
                <div class="empty-state">
                    <p>–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∂–∏–≤–æ—Ç–Ω–æ–º—É</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div id="history" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</h2>
            <div class="export-buttons">
                <button class="btn btn-secondary btn-small" onclick="showExportMenu()">–í—ã–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
        <div id="export-menu" class="export-menu" style="display: none;" onclick="if(event.target === this) hideExportMenu()">
            <div class="export-menu-content">
                <h3 id="export-menu-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö:</h3>
                <div id="export-type-selection" class="export-options">
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('feeding')">–î–Ω–µ–≤–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('weight')">–í–µ—Å</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('asthma')">–ü—Ä–∏—Å—Ç—É–ø—ã –∞—Å—Ç–º—ã</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('defecation')">–î–µ—Ñ–µ–∫–∞—Ü–∏–∏</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('litter')">–°–º–µ–Ω–∞ –ª–æ—Ç–∫–∞</button>
                </div>
                <div id="export-format-selection" class="export-options" style="display: none;">
                    <button class="btn btn-secondary btn-block" onclick="exportData('csv')">CSV</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('tsv')">TSV</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('html')">HTML</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('md')">Markdown</button>
                </div>
                <button id="export-back-btn" class="btn btn-primary btn-block" onclick="backToExportType()" style="display: none;">–ù–∞–∑–∞–¥</button>
                <button id="export-cancel-btn" class="btn btn-primary btn-block" onclick="hideExportMenu()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div class="history-tabs">
            <button class="tab-btn active" data-tab="feeding" onclick="showHistoryTab('feeding'); return false;">–î–Ω–µ–≤–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏</button>
            <button class="tab-btn" data-tab="weight" onclick="showHistoryTab('weight'); return false;">–í–µ—Å</button>
            <button class="tab-btn" data-tab="asthma" onclick="showHistoryTab('asthma'); return false;">–ü—Ä–∏—Å—Ç—É–ø—ã –∞—Å—Ç–º—ã</button>
            <button class="tab-btn" data-tab="defecation" onclick="showHistoryTab('defecation'); return false;">–î–µ—Ñ–µ–∫–∞—Ü–∏–∏</button>
            <button class="tab-btn" data-tab="litter" onclick="showHistoryTab('litter'); return false;">–°–º–µ–Ω–∞ –ª–æ—Ç–∫–∞</button>
        </div>
        <div id="history-content" class="history-content">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
    
    <!-- Alert Messages -->
    <div id="alert-container" class="alert-container"></div>
</div>

<script>
// Default settings
const DEFAULT_SETTINGS = {
    asthma: {
        duration: '–ö–æ—Ä–æ—Ç–∫–∏–π',
        inhalation: 'false',
        reason: '–ü–∏–ª'
    },
    defecation: {
        stool_type: '–û–±—ã—á–Ω—ã–π',
        color: '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π',
        food: 'Royal Canin Fibre Response'
    },
    weight: {
        food: 'Royal Canin Fibre Response'
    }
};

// Load settings from localStorage
function loadSettings() {
    const saved = localStorage.getItem('formDefaults');
    if (saved) {
        try {
            const settings = JSON.parse(saved);
            // Ensure backward compatibility - add color if missing
            if (settings.defecation && !settings.defecation.color) {
                settings.defecation.color = '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π';
            }
            return settings;
        } catch (e) {
            console.error('Error loading settings:', e);
        }
    }
    return DEFAULT_SETTINGS;
}

// Save settings to localStorage
function saveSettings(settings) {
    localStorage.setItem('formDefaults', JSON.stringify(settings));
}

// Get current settings
function getSettings() {
    return loadSettings();
}

// Set default date/time to now and apply saved defaults
function resetFormDefaults() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;
    const timeStr = now.toTimeString().slice(0, 5);
    const settings = getSettings();
    
    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º
    const formDefaults = {
        feeding: { date: dateStr, time: timeStr },
        asthma: { 
            date: dateStr, 
            time: timeStr,
            duration: settings.asthma.duration,
            inhalation: settings.asthma.inhalation,
            reason: settings.asthma.reason
        },
        defecation: {
            date: dateStr,
            time: timeStr,
            stool_type: settings.defecation.stool_type,
            color: settings.defecation.color || '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π',
            food: settings.defecation.food
        },
        litter: { date: dateStr, time: timeStr },
        weight: {
            date: dateStr,
            time: timeStr,
            food: settings.weight.food
        }
    };
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫ –∞–∫—Ç–∏–≤–Ω—ã–º —Ñ–æ—Ä–º–∞–º
    Object.keys(formDefaults).forEach(formType => {
        const config = FORM_CONFIGS[formType];
        if (!config) return;
        
        config.fields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element && formDefaults[formType][field.name] !== undefined) {
                element.value = formDefaults[formType][field.name];
            }
        });
    });
}

// Load settings into settings form
function loadSettingsForm() {
    const settings = getSettings();
    document.getElementById('default-asthma-duration').value = settings.asthma.duration;
    document.getElementById('default-asthma-inhalation').value = settings.asthma.inhalation;
    document.getElementById('default-asthma-reason').value = settings.asthma.reason;
    document.getElementById('default-defecation-stool-type').value = settings.defecation.stool_type;
    document.getElementById('default-defecation-color').value = settings.defecation.color || '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π';
    document.getElementById('default-defecation-food').value = settings.defecation.food;
    document.getElementById('default-weight-food').value = settings.weight.food;
}

// Reset settings to defaults
function resetSettingsToDefaults() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
        saveSettings(DEFAULT_SETTINGS);
        loadSettingsForm();
        showAlert('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
    }
}

// Pet management
let selectedPetId = null;
let selectedPetName = null;

function getSelectedPetId() {
    return localStorage.getItem('selectedPetId');
}

function setSelectedPet(petId, petName) {
    localStorage.setItem('selectedPetId', petId);
    localStorage.setItem('selectedPetName', petName);
    selectedPetId = petId;
    selectedPetName = petName;
    updatePetSwitcher();
    checkPetOwnership();
    // Reload current screen data if needed
    const activeScreen = document.querySelector('.screen.active');
    if (activeScreen && activeScreen.id === 'history') {
        const currentTab = document.querySelector('.tab-btn.active');
        if (currentTab) {
            const tabType = currentTab.getAttribute('data-tab');
            if (tabType) {
                showHistoryTab(tabType);
            }
        }
    }
}

function clearSelectedPet() {
    localStorage.removeItem('selectedPetId');
    localStorage.removeItem('selectedPetName');
    selectedPetId = null;
    selectedPetName = null;
    updatePetSwitcher();
}

async function loadPets() {
    try {
        const response = await fetch('/api/pets', {
            credentials: 'include'
        });
        const data = await response.json();
        return data.pets || [];
    } catch (error) {
        console.error('Error loading pets:', error);
        return [];
    }
}

async function renderPetsList() {
    const container = document.getElementById('pets-list');
    container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    const pets = await loadPets();
    
    if (pets.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∂–∏–≤–æ—Ç–Ω—ã—Ö. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ!</p></div>';
        return;
    }
    
    let html = '<div class="pets-grid">';
    pets.forEach(pet => {
        const photo = pet.photo_url ? pet.photo_url + '?t=' + new Date().getTime() : '';
        const isOwner = pet.current_user_is_owner || false;
        html += `
            <div class="pet-card">
                <div class="pet-card-content" onclick="selectPet('${pet._id}', '${pet.name}')">
                    ${photo ? `<img src="${photo}" alt="${pet.name}" class="pet-photo">` : '<div class="pet-photo-placeholder">üê±</div>'}
                    <div class="pet-info">
                        <h3>${pet.name}</h3>
                        ${pet.breed ? `<p>${pet.breed}</p>` : ''}
                        ${pet.gender ? `<p>${pet.gender}</p>` : ''}
                    </div>
                </div>
                <div class="pet-card-actions">
                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); editPet('${pet._id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    ${isOwner ? `<button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); showPetSharing('${pet._id}', '${pet.name}')">–î–æ—Å—Ç—É–ø</button>` : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function selectPet(petId, petName) {
    setSelectedPet(petId, petName);
    
    // Update pet switcher in navbar
    updatePetSwitcher();
    
    // Check if we're in a form screen or history screen
    const activeScreen = document.querySelector('.screen.active');
    const isInForm = activeScreen && (
        activeScreen.id === 'asthma-form' || 
        activeScreen.id === 'defecation-form' ||
        activeScreen.id === 'litter-form' ||
        activeScreen.id === 'weight-form' ||
        activeScreen.id === 'feeding-form' ||
        activeScreen.id === 'pet-form' ||
        activeScreen.id === 'user-form'
    );
    const isInHistory = activeScreen && activeScreen.id === 'history';
    const isInAdminPanel = activeScreen && activeScreen.id === 'admin-panel';
    const isInPetSelector = activeScreen && activeScreen.id === 'pet-selector';
    const isInPetSharing = activeScreen && activeScreen.id === 'pet-sharing';
    
    if (isInForm) {
        // Stay in the form
    } else if (isInHistory) {
        // Stay in history and reload current tab
        const currentTab = document.querySelector('.tab-btn.active');
        if (currentTab) {
            const tabType = currentTab.getAttribute('data-tab');
            if (tabType) {
                showHistoryTab(tabType);
            }
        }
    } else if (isInAdminPanel || isInPetSelector || isInPetSharing) {
        // Stay in current screen
    } else {
        // Return to main menu
        showScreen('main-menu');
    }
}

function updatePetSwitcher() {
    const switcher = document.getElementById('pet-switcher');
    const switcherName = document.getElementById('pet-switcher-name');
    
    if (switcher && switcherName) {
        // Always show switcher
        switcher.style.display = 'block';
        if (selectedPetId && selectedPetName) {
            // Update the name, arrow stays in place (it's outside the span in HTML)
            switcherName.textContent = selectedPetName;
        } else {
            switcherName.textContent = '–í—ã–±—Ä–∞—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ';
        }
    }
}


async function showPetSwitcherMenu() {
    const menu = document.getElementById('pet-switcher-menu');
    const list = document.getElementById('pet-switcher-list');
    
    if (!menu || !list) return;
    
    if (menu.style.display === 'block') {
        hidePetSwitcherMenu();
        return;
    }
    
    menu.style.display = 'block';
    list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    const pets = await loadPets();
    let html = '';
    
    pets.forEach(pet => {
        const isSelected = pet._id === selectedPetId;
        html += `
            <button class="pet-switcher-item ${isSelected ? 'active' : ''}" 
                    onclick="selectPet('${pet._id}', '${pet.name}'); hidePetSwitcherMenu();">
                ${pet.name}
            </button>
        `;
    });
    
    list.innerHTML = html;
}

function hidePetSwitcherMenu() {
    const menu = document.getElementById('pet-switcher-menu');
    if (menu) {
        menu.style.display = 'none';
    }
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
    const switcher = document.getElementById('pet-switcher');
    const menu = document.getElementById('pet-switcher-menu');
    if (switcher && menu && !switcher.contains(event.target)) {
        hidePetSwitcherMenu();
    }
});

async function checkAndSelectPet() {
    const savedPetId = getSelectedPetId();
    if (savedPetId) {
        // Verify pet still exists and user has access
        try {
            const response = await fetch(`/api/pets/${savedPetId}`, {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                setSelectedPet(savedPetId, data.pet.name);
                updatePetSwitcher();
                return true;
            }
        } catch (error) {
            console.error('Error checking pet:', error);
        }
    }
    
    // No valid pet selected, but don't force selector - let user work and choose when needed
    // Just show main menu, user can select pet from navbar
    updatePetSwitcher();
    return false;
}

document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const formTypes = ['feeding', 'asthma', 'defecation', 'litter', 'weight'];
    formTypes.forEach(formType => {
        const container = document.getElementById(`${formType}-form-container`);
        if (container) {
            container.innerHTML = createFormHTML(formType);
            const form = document.getElementById(`${formType}-form-element`);
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleFormSubmit(formType, form);
                });
            }
        }
    });
    
    resetFormDefaults();
    // Initialize selected pet from localStorage
    selectedPetId = getSelectedPetId();
    selectedPetName = localStorage.getItem('selectedPetName');
    // Always show pet switcher
    const switcher = document.getElementById('pet-switcher');
    if (switcher) {
        switcher.style.display = 'block';
    }
    updatePetSwitcher();
    checkAdminStatus().then(() => {
        checkAndSelectPet().then(() => {
            checkPetOwnership();
        });
    });
});

function showScreen(screenId) {
    // Hide all screens
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    // Show selected screen
    const screen = document.getElementById(screenId);
    if (screen) {
        screen.classList.add('active');
        // Scroll to top
        window.scrollTo(0, 0);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–æ—Ä–º—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è —Ç–∏–ø–æ–≤ –∑–∞–ø–∏—Å–µ–π
        const formTypes = ['feeding', 'asthma', 'defecation', 'litter', 'weight'];
        const formType = formTypes.find(type => screenId === `${type}-form`);
        
        if (formType) {
            const container = document.getElementById(`${formType}-form-container`);
            if (container) {
                const formElement = document.getElementById(`${formType}-form-element`);
                const recordId = formElement ? formElement.querySelector('[name="record_id"]')?.value : null;
                
                // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É (—É–∂–µ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏–∑ localStorage)
                container.innerHTML = createFormHTML(formType, recordId);
                
                // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                const newForm = document.getElementById(`${formType}-form-element`);
                if (newForm) {
                    newForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        handleFormSubmit(formType, newForm);
                    });
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
                // (date/time –æ–±–Ω–æ–≤—è—Ç—Å—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–æ—Ä–º—ã)
                if (!recordId) {
                    resetFormDefaults();
                }
            }
        } else if (screenId === 'settings') {
            loadSettingsForm();
        } else if (screenId === 'pet-selector') {
            renderPetsList();
        } else if (screenId === 'pet-form') {
            const recordId = document.getElementById('pet-record-id')?.value;
            if (!recordId) {
                resetPetForm();
            }
        } else if (screenId === 'admin-panel') {
            loadUsersList();
        } else if (screenId === 'user-form') {
            const recordUsername = document.getElementById('user-record-username')?.value;
            if (!recordUsername) {
                resetUserForm();
            }
        } else if (screenId === 'pet-sharing') {
            loadPetSharing();
        } else if (screenId === 'history') {
            showHistoryTab('feeding');
        }
    }
}


let currentHistoryType = 'asthma';
let selectedExportType = null;

function showExportMenu() {
    selectedExportType = null;
    document.getElementById('export-type-selection').style.display = 'block';
    document.getElementById('export-format-selection').style.display = 'none';
    document.getElementById('export-back-btn').style.display = 'none';
    document.getElementById('export-cancel-btn').style.display = 'block';
    document.getElementById('export-menu-title').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö:';
    document.getElementById('export-menu').style.display = 'flex';
}

function hideExportMenu() {
    document.getElementById('export-menu').style.display = 'none';
    selectedExportType = null;
}

function selectExportType(type) {
    selectedExportType = type;
    document.getElementById('export-type-selection').style.display = 'none';
    document.getElementById('export-format-selection').style.display = 'block';
    document.getElementById('export-back-btn').style.display = 'block';
    document.getElementById('export-cancel-btn').style.display = 'none';
    let typeName;
    if (type === 'feeding') {
        typeName = '–î–Ω–µ–≤–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏';
    } else if (type === 'asthma') {
        typeName = '–ü—Ä–∏—Å—Ç—É–ø—ã –∞—Å—Ç–º—ã';
    } else if (type === 'defecation') {
        typeName = '–î–µ—Ñ–µ–∫–∞—Ü–∏–∏';
    } else if (type === 'litter') {
        typeName = '–°–º–µ–Ω–∞ –ª–æ—Ç–∫–∞';
    } else {
        typeName = '–í–µ—Å';
    }
    document.getElementById('export-menu-title').textContent = `–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç (${typeName}):`;
}

function backToExportType() {
    selectedExportType = null;
    document.getElementById('export-type-selection').style.display = 'block';
    document.getElementById('export-format-selection').style.display = 'none';
    document.getElementById('export-back-btn').style.display = 'none';
    document.getElementById('export-cancel-btn').style.display = 'block';
    document.getElementById('export-menu-title').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö:';
}

async function exportData(format) {
    if (!selectedExportType) {
        showAlert('error', '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö');
        return;
    }
    
    const petId = getSelectedPetId();
    if (!petId) {
        showAlert('error', '–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ');
        return;
    }
    
    const url = `/api/export/${selectedExportType}/${format}?pet_id=${petId}`;
    
    try {
        const response = await fetch(url, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ' }));
            showAlert('error', errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ');
            return;
        }
        
        // Get filename from Content-Disposition header or generate one
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = '';
        if (contentDisposition) {
            // Try RFC 5987 format first: filename*=UTF-8''encoded-name
            const rfc5987Match = contentDisposition.match(/filename\*=UTF-8''(.+)/);
            if (rfc5987Match) {
                filename = decodeURIComponent(rfc5987Match[1]);
            } else {
                // Fallback to standard format
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
        }
        
        if (!filename) {
            const typeName = selectedExportType === 'asthma' ? 'asthma' : 'defecation';
            filename = `${typeName}_${new Date().toISOString().slice(0, 10)}.${format}`;
        }
        
        // Create blob and download
        const blob = await response.blob();
        const blobUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(blobUrl);
        
        hideExportMenu();
        showAlert('success', '–§–∞–π–ª –≤—ã–≥—Ä—É–∂–µ–Ω');
    } catch (error) {
        console.error('Export error:', error);
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
    }
}

// Format date from YYYY-MM-DD HH:MM to DD.MM.YYYY HH:MM
function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    const parts = dateTimeStr.split(' ');
    if (parts.length !== 2) return dateTimeStr;
    const [datePart, timePart] = parts;
    const dateParts = datePart.split('-');
    if (dateParts.length !== 3) return dateTimeStr;
    const [year, month, day] = dateParts;
    return `${day}.${month}.${year} ${timePart}`;
}

function showHistoryTab(type) {
    currentHistoryType = type;
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        const isFeeding = type === 'feeding' && btn.textContent.includes('–î–Ω–µ–≤–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏');
        const isAsthma = type === 'asthma' && btn.textContent.includes('–∞—Å—Ç–º—ã');
        const isDefecation = type === 'defecation' && btn.textContent.includes('–î–µ—Ñ–µ–∫–∞—Ü–∏–∏');
        const isLitter = type === 'litter' && btn.textContent.includes('–°–º–µ–Ω–∞ –ª–æ—Ç–∫–∞');
        const isWeight = type === 'weight' && btn.textContent.includes('–í–µ—Å');
        if (isFeeding || isAsthma || isDefecation || isLitter || isWeight) {
            btn.classList.add('active');
        }
    });
    
    const content = document.getElementById('history-content');
    const petId = getSelectedPetId();
    
    if (!petId) {
        content.innerHTML = '<div class="empty-state"><p>–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ –≤ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏</p></div>';
        return;
    }
    
    content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    let endpoint;
    if (type === 'feeding') {
        endpoint = `/api/feeding?pet_id=${petId}`;
    } else if (type === 'asthma') {
        endpoint = `/api/asthma?pet_id=${petId}`;
    } else if (type === 'defecation') {
        endpoint = `/api/defecation?pet_id=${petId}`;
    } else if (type === 'litter') {
        endpoint = `/api/litter?pet_id=${petId}`;
    } else {
        endpoint = `/api/weight?pet_id=${petId}`;
    }
    
    fetch(endpoint, { credentials: 'include' })
        .then(response => {
            if (!response.ok) {
                // If response is not ok, try to parse error message
                return response.json().then(data => {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }).catch(() => {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                });
            }
            return response.json();
        })
        .then(data => {
            let items;
            if (type === 'feeding') {
                items = data.feedings || [];
            } else if (type === 'asthma') {
                items = data.attacks || [];
            } else if (type === 'defecation') {
                items = data.defecations || [];
            } else if (type === 'litter') {
                items = data.litter_changes || [];
            } else {
                items = data.weights || [];
            }
            
            if (!items || items.length === 0) {
                content.innerHTML = '<p class="no-data">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
                return;
            }
            
            let html = '<div class="history-list">';
            items.forEach(item => {
                html += `<div class="history-item history-item-${type}" data-id="${item._id}">`;
                html += `<div class="history-date">${formatDateTime(item.date_time)}</div>`;
                const username = item.username || '-';
                html += `<div class="history-user"><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${username}</div>`;
                if (type === 'feeding') {
                    html += `<div class="history-details">`;
                    html += `<span><strong>–í–µ—Å –∫–æ—Ä–º–∞:</strong> ${item.food_weight} –≥</span>`;
                    if (item.comment && item.comment !== '-') {
                        html += `<span><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${item.comment}</span>`;
                    }
                    html += `</div>`;
                } else if (type === 'asthma') {
                    html += `<div class="history-details">`;
                    html += `<span><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${item.duration}</span>`;
                    html += `<span><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${item.reason}</span>`;
                    html += `<span><strong>–ò–Ω–≥–∞–ª—è—Ü–∏—è:</strong> ${item.inhalation}</span>`;
                    if (item.comment && item.comment !== '-') {
                        html += `<span><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${item.comment}</span>`;
                    }
                    html += `</div>`;
                } else if (type === 'defecation') {
                    html += `<div class="history-details">`;
                    html += `<span><strong>–¢–∏–ø —Å—Ç—É–ª–∞:</strong> ${item.stool_type}</span>`;
                    if (item.color) {
                        html += `<span><strong>–¶–≤–µ—Ç —Å—Ç—É–ª–∞:</strong> ${item.color}</span>`;
                    }
                    if (item.food && item.food !== '-') {
                        html += `<span><strong>–ö–æ—Ä–º:</strong> ${item.food}</span>`;
                    }
                    if (item.comment && item.comment !== '-') {
                        html += `<span><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${item.comment}</span>`;
                    }
                    html += `</div>`;
                } else if (type === 'litter') {
                    html += `<div class="history-details">`;
                    if (item.comment && item.comment !== '-') {
                        html += `<span><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${item.comment}</span>`;
                    }
                    html += `</div>`;
                } else if (type === 'weight') {
                    html += `<div class="history-details">`;
                    html += `<span><strong>–í–µ—Å:</strong> ${item.weight} –∫–≥</span>`;
                    if (item.food && item.food !== '-') {
                        html += `<span><strong>–ö–æ—Ä–º:</strong> ${item.food}</span>`;
                    }
                    if (item.comment && item.comment !== '-') {
                        html += `<span><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${item.comment}</span>`;
                    }
                    html += `</div>`;
                }
                html += `<div class="history-actions">`;
                html += `<button class="btn btn-secondary btn-small" onclick="editRecord('${type}', '${item._id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;
                html += `<button class="btn btn-secondary btn-small" onclick="deleteRecord('${type}', '${item._id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                html += `</div>`;
                html += '</div>';
            });
            html += '</div>';
            content.innerHTML = html;
        })
        .catch(error => {
            content.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            console.error('Error:', error);
        });
}

// Admin panel functions
let isAdmin = false;

async function checkAdminStatus() {
    try {
        const response = await fetch('/api/users', {
            credentials: 'include'
        });
        isAdmin = response.ok;
        if (isAdmin) {
            // Show admin panel link in menu
            const adminLink = document.querySelector('.admin-link');
            if (adminLink) {
                adminLink.style.display = 'flex';
            }
        }
        return isAdmin;
    } catch (error) {
        isAdmin = false;
        return false;
    }
}

async function checkPetOwnership() {
    // This function is no longer needed as sharing is now in pet-selector
    // Keeping it for backward compatibility but it does nothing
}

async function loadUsersList() {
    const container = document.getElementById('users-list');
    if (!container) return;
    
    container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    try {
        const response = await fetch('/api/users', {
            credentials: 'include'
        });
        
        if (!response.ok) {
            container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
            return;
        }
        
        const data = await response.json();
        const users = data.users || [];
        
        if (users.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p></div>';
            return;
        }
        
        // Desktop table view
        let html = '<div class="users-table">';
        html += '<div class="table-header">';
        html += '<div>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
        html += '<div>–ü–æ–ª–Ω–æ–µ –∏–º—è</div>';
        html += '<div>Email</div>';
        html += '<div>–°—Ç–∞—Ç—É—Å</div>';
        html += '<div>–î–µ–π—Å—Ç–≤–∏—è</div>';
        html += '</div>';
        
        users.forEach(user => {
            html += `<div class="table-row">`;
            html += `<div>${user.username}</div>`;
            html += `<div>${user.full_name || '-'}</div>`;
            html += `<div>${user.email || '-'}</div>`;
            html += `<div>${user.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</div>`;
            html += `<div class="table-actions">`;
            html += `<button class="btn btn-secondary btn-small" onclick="editUser('${user.username}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;
            if (user.username !== 'admin') {
                html += `<button class="btn btn-secondary btn-small" onclick="resetUserPassword('${user.username}')">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>`;
                if (user.is_active) {
                    html += `<button class="btn btn-secondary btn-small" onclick="deactivateUser('${user.username}')">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`;
                } else {
                    html += `<button class="btn btn-primary btn-small" onclick="activateUser('${user.username}')">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`;
                }
            }
            html += `</div>`;
            html += `</div>`;
        });
        
        html += '</div>';
        
        // Mobile card view
        html += '<div class="users-cards">';
        users.forEach(user => {
            html += `<div class="user-card">`;
            html += `<div class="user-card-header">`;
            html += `<div class="user-card-title">`;
            html += `<h4>${user.username}</h4>`;
            html += `<span class="user-status-badge ${user.is_active ? 'active' : 'inactive'}">${user.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>`;
            html += `</div>`;
            html += `</div>`;
            html += `<div class="user-card-body">`;
            if (user.full_name) {
                html += `<div class="user-card-field">`;
                html += `<span class="user-card-label">–ü–æ–ª–Ω–æ–µ –∏–º—è:</span>`;
                html += `<span class="user-card-value">${user.full_name}</span>`;
                html += `</div>`;
            }
            if (user.email) {
                html += `<div class="user-card-field">`;
                html += `<span class="user-card-label">Email:</span>`;
                html += `<span class="user-card-value">${user.email}</span>`;
                html += `</div>`;
            }
            html += `</div>`;
            html += `<div class="user-card-actions">`;
            html += `<button class="btn btn-secondary btn-block" onclick="editUser('${user.username}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;
            if (user.username !== 'admin') {
                html += `<button class="btn btn-secondary btn-block" onclick="resetUserPassword('${user.username}')">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>`;
                if (user.is_active) {
                    html += `<button class="btn btn-secondary btn-block" onclick="deactivateUser('${user.username}')">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`;
                } else {
                    html += `<button class="btn btn-primary btn-block" onclick="activateUser('${user.username}')">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`;
                }
            }
            html += `</div>`;
            html += `</div>`;
        });
        html += '</div>';
        
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
        console.error('Error:', error);
    }
}

function resetUserForm() {
    // Clear all form fields
    document.getElementById('user-record-username').value = '';
    document.getElementById('user-form-element').reset();
    
    // Reset form state to "add new user"
    document.getElementById('user-username').value = '';
    document.getElementById('user-username').disabled = false;
    document.getElementById('user-password').value = '';
    document.getElementById('user-password').required = true;
    document.getElementById('user-password-label').textContent = '–ü–∞—Ä–æ–ª—å *';
    document.getElementById('user-full-name').value = '';
    document.getElementById('user-email').value = '';
    document.getElementById('user-form-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
    document.getElementById('user-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
}

async function editUser(username) {
    try {
        const response = await fetch(`/api/users/${username}`, {
            credentials: 'include'
        });
        const data = await response.json();
        const user = data.user;
        
        // Set record username first to prevent form reset
        document.getElementById('user-record-username').value = user.username;
        
        // Fill form fields
        document.getElementById('user-username').value = user.username;
        document.getElementById('user-username').disabled = true; // Username cannot be changed when editing
        document.getElementById('user-password').value = '';
        document.getElementById('user-password').required = false;
        document.getElementById('user-password-label').textContent = '–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)';
        document.getElementById('user-full-name').value = user.full_name || '';
        document.getElementById('user-email').value = user.email || '';
        document.getElementById('user-form-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        document.getElementById('user-submit-btn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
        
        // Show form screen (won't reset because record-username is set)
        showScreen('user-form');
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        console.error('Error loading user:', error);
    }
}

async function resetUserPassword(username) {
    const newPassword = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:');
    if (!newPassword) return;
    
    try {
        const response = await fetch(`/api/users/${username}/reset-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({password: newPassword})
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω');
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
    }
}

async function deactivateUser(username) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/users/${username}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            loadUsersList();
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏');
    }
}

async function activateUser(username) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/users/${username}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({is_active: true})
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            loadUsersList();
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏');
    }
}

// User form submission
document.getElementById('user-form-element').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const recordUsername = formData.get('username');
    const username = document.getElementById('user-username').value;
    const password = formData.get('password');
    const data = {
        username: username,
        full_name: formData.get('full_name') || '',
        email: formData.get('email') || ''
    };
    
    if (recordUsername) {
        // Update existing user
        if (password) {
            // Reset password if provided
            try {
                const resetResponse = await fetch(`/api/users/${username}/reset-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({password: password})
                });
                if (!resetResponse.ok) {
                    const errorData = await resetResponse.json();
                    showAlert('error', errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
                    return;
                }
            } catch (error) {
                showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
                return;
            }
        }
        
        // Update user info
        try {
            const response = await fetch(`/api/users/${username}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (response.ok) {
                showAlert('success', result.message || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                resetUserForm();
                setTimeout(() => {
                    showScreen('admin-panel');
                    loadUsersList();
                }, 500);
            } else {
                showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            }
        } catch (error) {
            showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
    } else {
        // Create new user
        if (!password) {
            showAlert('error', '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
        }
        
        data.password = password;
        
        try {
            const response = await fetch('/api/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (response.ok) {
                showAlert('success', result.message || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                resetUserForm();
                setTimeout(() => {
                    showScreen('admin-panel');
                    loadUsersList();
                }, 500);
            } else {
                showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            }
        } catch (error) {
            showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
    }
});

// Pet sharing functions
function showPetSharing(petId, petName) {
    setSelectedPet(petId, petName);
    loadPetSharing();
}

async function editPet(petId) {
    try {
        const response = await fetch(`/api/pets/${petId}`, {
            credentials: 'include'
        });
        const data = await response.json();
        const pet = data.pet;
        
        // Fill form fields
        document.getElementById('pet-record-id').value = pet._id;
        document.getElementById('pet-name').value = pet.name || '';
        document.getElementById('pet-breed').value = pet.breed || '';
        document.getElementById('pet-birth-date').value = pet.birth_date || '';
        document.getElementById('pet-gender').value = pet.gender || '';
        document.getElementById('pet-form-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Ç–æ–º—Ü–∞';
        document.getElementById('pet-submit-btn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
        
        // Show current photo if exists
        const photoCurrent = document.getElementById('pet-photo-current');
        const photoCurrentImg = document.getElementById('pet-photo-current-img');
        if (pet.photo_url) {
            photoCurrentImg.src = pet.photo_url + '?t=' + new Date().getTime();
            photoCurrent.style.display = 'block';
        } else {
            photoCurrent.style.display = 'none';
        }
        
        // Show access management section if user is owner
        const accessSection = document.getElementById('pet-access-section');
        if (pet.current_user_is_owner) {
            accessSection.style.display = 'block';
            await loadPetAccessInForm(petId);
        } else {
            accessSection.style.display = 'none';
        }
        
        showScreen('pet-form');
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∏—Ç–æ–º—Ü–∞');
        console.error('Error loading pet:', error);
    }
}

async function loadPetAccessInForm(petId) {
    try {
        const response = await fetch(`/api/pets/${petId}`, {
            credentials: 'include'
        });
        const data = await response.json();
        const pet = data.pet;
        
        // Load shared users
        const sharedList = document.getElementById('pet-shared-with-list');
        const sharedWith = pet.shared_with || [];
        if (sharedWith.length === 0) {
            sharedList.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–æ—Å—Ç—É–ø–æ–º</p></div>';
        } else {
            let html = '<div class="shared-users-list">';
            sharedWith.forEach(username => {
                html += `
                    <div class="shared-user-item">
                        <div class="shared-user-name">${username}</div>
                        <div class="shared-user-actions">
                            <button class="btn btn-secondary btn-block" onclick="unsharePetFromForm('${petId}', '${username}')">–£–±—Ä–∞—Ç—å –¥–æ—Å—Ç—É–ø</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            sharedList.innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading pet access:', error);
    }
}

async function sharePetFromForm() {
    const petId = document.getElementById('pet-record-id').value;
    const usernameInput = document.getElementById('share-username-input');
    const username = usernameInput.value.trim();
    
    if (!username) {
        showAlert('error', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    if (!petId) {
        showAlert('error', '–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∏—Ç–æ–º—Ü–∞');
        return;
    }
    
    try {
        const response = await fetch(`/api/pets/${petId}/share`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({username: username})
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–î–æ—Å—Ç—É–ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
            usernameInput.value = '';
            await loadPetAccessInForm(petId);
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞');
    }
}

async function unsharePetFromForm(petId, username) {
    if (!confirm(`–£–±—Ä–∞—Ç—å –¥–æ—Å—Ç—É–ø —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/pets/${petId}/share/${username}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–î–æ—Å—Ç—É–ø —É–±—Ä–∞–Ω');
            await loadPetAccessInForm(petId);
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞');
    }
}

async function loadPetSharing() {
    const petId = getSelectedPetId();
    if (!petId) {
        showAlert('error', '–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ');
        return;
    }
    
    // –ë–µ–π–¥–∂ —É–¥–∞–ª–µ–Ω - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∂–∏–≤–æ—Ç–Ω–æ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –Ω–∞–≤–±–∞—Ä–µ
    
    try {
        const response = await fetch(`/api/pets/${petId}`, {
            credentials: 'include'
        });
        
        if (!response.ok) {
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∏—Ç–æ–º—Ü–µ');
            return;
        }
        
        const data = await response.json();
        const pet = data.pet;
        
        // Check if current user is owner (from API response)
        const userIsOwner = pet.current_user_is_owner || false;
        const sharedWith = pet.shared_with || [];
        // User has access if they can see this screen (they're owner or in shared_with)
        const hasAccess = userIsOwner || sharedWith.length >= 0; // Always true if they reached this screen
        
        // Show/hide sections
        document.getElementById('sharing-owner-section').style.display = userIsOwner ? 'block' : 'none';
        document.getElementById('sharing-user-section').style.display = hasAccess ? 'none' : 'block';
        
        // Load shared users
        if (hasAccess) {
            await loadSharedWithList(pet);
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        console.error('Error:', error);
    }
}

async function loadSharedWithList(pet) {
    const container = document.getElementById('shared-with-list');
    const sharedWith = pet.shared_with || [];
    
    if (sharedWith.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–æ—Å—Ç—É–ø–æ–º</p></div>';
        return;
    }
    
        let html = '<div class="shared-users-list">';
        sharedWith.forEach(username => {
            html += `
                <div class="shared-user-item">
                    <div class="shared-user-name">${username}</div>
                    ${pet.current_user_is_owner ? `
                    <div class="shared-user-actions">
                        <button class="btn btn-secondary btn-block" onclick="unsharePet('${username}')">–£–±—Ä–∞—Ç—å –¥–æ—Å—Ç—É–ø</button>
                    </div>
                    ` : ''}
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
}

async function sharePetWithUser(username) {
    const petId = getSelectedPetId();
    if (!petId) {
        showAlert('error', '–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ –≤ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
        return;
    }
    
    try {
        const response = await fetch(`/api/pets/${petId}/share`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({username: username})
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–î–æ—Å—Ç—É–ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
            document.getElementById('share-form').reset();
            loadPetSharing();
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞');
    }
}

async function unsharePet(username) {
    const petId = getSelectedPetId();
    if (!petId) {
        return;
    }
    
    if (!confirm(`–£–±—Ä–∞—Ç—å –¥–æ—Å—Ç—É–ø —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/pets/${petId}/share/${username}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–î–æ—Å—Ç—É–ø —É–±—Ä–∞–Ω');
            loadPetSharing();
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞');
    }
}

// Share form submission
document.getElementById('share-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const username = formData.get('username').trim();
    
    if (!username) {
        showAlert('error', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    await sharePetWithUser(username);
});

// Pet photo file input handler
document.getElementById('pet-photo-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('pet-photo-preview');
    const previewImg = document.getElementById('pet-photo-preview-img');
    const photoCurrent = document.getElementById('pet-photo-current');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            previewImg.style.display = 'block';
            // Hide current photo when new photo is selected
            if (photoCurrent) {
                photoCurrent.style.display = 'none';
            }
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

function clearPetPhoto() {
    document.getElementById('pet-photo-file').value = '';
    document.getElementById('pet-photo-preview').style.display = 'none';
    // Mark photo for removal
    const form = document.getElementById('pet-form-element');
    const removeInput = document.createElement('input');
    removeInput.type = 'hidden';
    removeInput.name = 'remove_photo';
    removeInput.value = 'true';
    form.appendChild(removeInput);
}

// Pet form submission
document.getElementById('pet-form-element').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const recordId = formData.get('pet_id');
    
    try {
        const url = recordId ? `/api/pets/${recordId}` : '/api/pets';
        const method = recordId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            credentials: 'include',
            body: formData
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || (recordId ? '–ü–∏—Ç–æ–º–µ—Ü –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ü–∏—Ç–æ–º–µ—Ü —Å–æ–∑–¥–∞–Ω'));
            
            // Reset form
            resetPetForm();
            
            // If new pet created, set it as selected
            if (!recordId && result.pet) {
                setSelectedPet(result.pet._id, result.pet.name);
            }
            
            // Reload pets list to show updated data
            await renderPetsList();
            
            // Return to pet selector screen (same as events)
            setTimeout(() => {
                showScreen('pet-selector');
            }, 150);
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
});

function resetPetForm() {
    document.getElementById('pet-form-element').reset();
    document.getElementById('pet-record-id').value = '';
    document.getElementById('pet-form-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞';
    document.getElementById('pet-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const preview = document.getElementById('pet-photo-preview');
    const previewImg = document.getElementById('pet-photo-preview-img');
    if (preview) {
        preview.style.display = 'none';
        if (previewImg) {
            previewImg.src = '';
        }
    }
    const photoCurrent = document.getElementById('pet-photo-current');
    if (photoCurrent) {
        photoCurrent.style.display = 'none';
    }
    document.getElementById('pet-access-section').style.display = 'none';
}

// Form submissions - —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º handleFormSubmit –≤ forms-config.js
// –°—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω—ã –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∫–æ–¥–∞ (~260 —Å—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ)

// Settings form submission
document.getElementById('settings-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const settings = {
        asthma: {
            duration: document.getElementById('default-asthma-duration').value,
            inhalation: document.getElementById('default-asthma-inhalation').value,
            reason: document.getElementById('default-asthma-reason').value
        },
        defecation: {
            stool_type: document.getElementById('default-defecation-stool-type').value,
            color: document.getElementById('default-defecation-color').value,
            food: document.getElementById('default-defecation-food').value
        },
        weight: {
            food: document.getElementById('default-weight-food').value
        }
    };
    
    saveSettings(settings);
    showAlert('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    setTimeout(() => {
        showScreen('main-menu');
    }, 500);
});

function showAlert(type, message) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

async function editRecord(type, recordId) {
    const petId = getSelectedPetId();
    if (!petId) {
        showAlert('error', '–í—ã–±–µ—Ä–∏—Ç–µ –∂–∏–≤–æ—Ç–Ω–æ–µ –≤ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
        return;
    }
    
    let endpoint;
    if (type === 'feeding') {
        endpoint = `/api/feeding?pet_id=${petId}`;
    } else if (type === 'asthma') {
        endpoint = `/api/asthma?pet_id=${petId}`;
    } else if (type === 'defecation') {
        endpoint = `/api/defecation?pet_id=${petId}`;
    } else if (type === 'litter') {
        endpoint = `/api/litter?pet_id=${petId}`;
    } else {
        endpoint = `/api/weight?pet_id=${petId}`;
    }
    
    try {
        const response = await fetch(endpoint, {
            credentials: 'include'
        });
        const data = await response.json();
        let items;
        if (type === 'feeding') {
            items = data.feedings;
        } else if (type === 'asthma') {
            items = data.attacks;
        } else if (type === 'defecation') {
            items = data.defecations;
        } else if (type === 'litter') {
            items = data.litter_changes;
        } else {
            items = data.weights;
        }
        const record = items.find(item => item._id === recordId);
        
        if (!record) {
            // Record was deleted by another user (race condition)
            showAlert('info', '–ó–∞–ø–∏—Å—å –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
            // Refresh history to remove the deleted record from UI
            showHistoryTab(type);
            return;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        const formRecord = { ...record };
        if (type === 'asthma' && record.inhalation === '–î–∞') {
            formRecord.inhalation = 'true';
        } else if (type === 'asthma' && record.inhalation === '–ù–µ—Ç') {
            formRecord.inhalation = 'false';
        }
        
        populateForm(type, formRecord, recordId);
        showScreen(`${type}-form`);
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–ø–∏—Å–∏');
        console.error('Error:', error);
    }
}

async function deleteRecord(type, recordId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
        return;
    }

    const endpoint = `/api/${type}/${recordId}`;

    try {
        const response = await fetch(endpoint, {
            method: 'DELETE',
            credentials: 'include'
        });

        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
            // Reload history
            const currentTab = document.querySelector('.tab-btn.active');
            if (currentTab.textContent.includes('–î–Ω–µ–≤–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏')) {
                showHistoryTab('feeding');
            } else if (currentTab.textContent.includes('–∞—Å—Ç–º—ã')) {
                showHistoryTab('asthma');
            } else if (currentTab.textContent.includes('–î–µ—Ñ–µ–∫–∞—Ü–∏–∏')) {
                showHistoryTab('defecation');
            } else if (currentTab.textContent.includes('–°–º–µ–Ω–∞ –ª–æ—Ç–∫–∞')) {
                showHistoryTab('litter');
            } else if (currentTab.textContent.includes('–í–µ—Å')) {
                showHistoryTab('weight');
            }
        } else if (response.status === 404) {
            // Record already deleted (race condition: another user deleted it)
            // Treat as success and refresh history
            showAlert('info', '–ó–∞–ø–∏—Å—å —É–∂–µ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞');
            // Reload history
            const currentTab = document.querySelector('.tab-btn.active');
            if (currentTab.textContent.includes('–î–Ω–µ–≤–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏')) {
                showHistoryTab('feeding');
            } else if (currentTab.textContent.includes('–∞—Å—Ç–º—ã')) {
                showHistoryTab('asthma');
            } else if (currentTab.textContent.includes('–î–µ—Ñ–µ–∫–∞—Ü–∏–∏')) {
                showHistoryTab('defecation');
            } else if (currentTab.textContent.includes('–°–º–µ–Ω–∞ –ª–æ—Ç–∫–∞')) {
                showHistoryTab('litter');
            } else if (currentTab.textContent.includes('–í–µ—Å')) {
                showHistoryTab('weight');
            }
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        console.error('Error:', error);
    }
}
</script>
{% endblock %}
