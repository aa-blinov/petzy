{% extends "base.html" %}

{% block title %}Petzy{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Main Menu -->
    <div id="main-menu" class="screen active">
        <div class="action-cards" id="action-cards-container">
            <div class="card action-card" data-tile-id="feeding" data-color="brown" onclick="showScreen('feeding-form')">
                <h3>Дневная порция корма</h3>
                <p>Записать порцию</p>
            </div>
            
            <div class="card action-card" data-tile-id="weight" data-color="orange" onclick="showScreen('weight-form')">
                <h3>Вес</h3>
                <p>Записать вес</p>
            </div>
            
            <div class="card action-card" data-tile-id="asthma" data-color="red" onclick="showScreen('asthma-form')">
                <h3>Приступ астмы</h3>
                <p>Записать приступ</p>
            </div>
            
            <div class="card action-card" data-tile-id="defecation" data-color="green" onclick="showScreen('defecation-form')">
                <h3>Дефекация</h3>
                <p>Записать дефекацию</p>
            </div>
            
            <div class="card action-card" data-tile-id="litter" data-color="purple" onclick="showScreen('litter-form')">
                <h3>Смена лотка</h3>
                <p>Записать смену лотка</p>
            </div>

            <div class="card action-card" data-tile-id="eye_drops" data-color="teal" onclick="showScreen('eye-drops-form')">
                <h3>Закапывание глаз</h3>
                <p>Записать капли</p>
            </div>

            <div class="card action-card" data-tile-id="tooth_brushing" data-color="cyan" onclick="showScreen('tooth-brushing-form')">
                <h3>Чистка зубов</h3>
                <p>Записать чистку</p>
            </div>

            <div class="card action-card" data-tile-id="ear_cleaning" data-color="yellow" onclick="showScreen('ear-cleaning-form')">
                <h3>Чистка ушей</h3>
                <p>Записать чистку</p>
            </div>
            
            <div class="card action-card" data-tile-id="history" data-color="blue" onclick="showScreen('history')">
                <h3>История</h3>
                <p>Просмотр записей</p>
            </div>
            
            <div class="card action-card admin-link" data-tile-id="admin" data-color="pink" onclick="showScreen('admin-panel')" style="display: none;">
                <h3>Админ-панель</h3>
                <p>Управление пользователями</p>
            </div>
        </div>
    </div>
    
    <!-- Feeding Form -->
    <div id="feeding-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Записать дневную порцию корма</h2>
        </div>
        <div id="feeding-form-container"></div>
    </div>
    
    <!-- Asthma Form -->
    <div id="asthma-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Записать приступ астмы</h2>
        </div>
        <div id="asthma-form-container"></div>
    </div>
    
    <!-- Defecation Form -->
    <div id="defecation-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Записать дефекацию</h2>
        </div>
        <div id="defecation-form-container"></div>
    </div>
    
    <!-- Litter Change Form -->
    <div id="litter-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Записать смену лотка</h2>
        </div>
        <div id="litter-form-container"></div>
    </div>
    
    <!-- Weight Form -->
    <div id="weight-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Записать вес</h2>
        </div>
        <div id="weight-form-container"></div>
    </div>

    <!-- Eye Drops Form -->
    <div id="eye-drops-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Записать закапывание глаз</h2>
        </div>
        <div id="eye-drops-form-container"></div>
    </div>

    <!-- Tooth Brushing Form -->
    <div id="tooth-brushing-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Записать чистку зубов</h2>
        </div>
        <div id="tooth-brushing-form-container"></div>
    </div>

    <!-- Ear Cleaning Form -->
    <div id="ear-cleaning-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Записать чистку ушей</h2>
        </div>
        <div id="ear-cleaning-form-container"></div>
    </div>
    
    <!-- Settings Screen -->
    <div id="settings" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Настройки значений по умолчанию</h2>
        </div>
        <form id="settings-form" class="inline-form" autocomplete="off">
            <div class="form-content">
                <div class="settings-section">
                    <h3>Приступ астмы</h3>
                    <div class="form-group">
                        <label for="default-asthma-duration">Длительность по умолчанию</label>
                        <select id="default-asthma-duration" name="default_asthma_duration">
                            <option value="Короткий">Короткий</option>
                            <option value="Длительный">Длительный</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-asthma-inhalation">Ингаляция по умолчанию</label>
                        <select id="default-asthma-inhalation" name="default_asthma_inhalation">
                            <option value="false">Нет</option>
                            <option value="true">Да</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-asthma-reason">Причина по умолчанию</label>
                        <input type="text" id="default-asthma-reason" name="default_asthma_reason" placeholder="Пил">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Дефекация</h3>
                    <div class="form-group">
                        <label for="default-defecation-stool-type">Тип стула по умолчанию</label>
                        <select id="default-defecation-stool-type" name="default_defecation_stool_type">
                            <option value="Обычный">Обычный</option>
                            <option value="Твердый">Твердый</option>
                            <option value="Жидкий">Жидкий</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-defecation-color">Цвет стула по умолчанию</label>
                        <select id="default-defecation-color" name="default_defecation_color">
                            <option value="Коричневый">Коричневый</option>
                            <option value="Темно-коричневый">Темно-коричневый</option>
                            <option value="Светло-коричневый">Светло-коричневый</option>
                            <option value="Другой">Другой</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="default-defecation-food">Корм по умолчанию</label>
                        <input type="text" id="default-defecation-food" name="default_defecation_food" placeholder="Royal Canin Fibre Response">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Вес</h3>
                    <div class="form-group">
                        <label for="default-weight-food">Корм по умолчанию</label>
                        <input type="text" id="default-weight-food" name="default_weight_food" placeholder="Royal Canin Fibre Response">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Закапывание глаз</h3>
                    <div class="form-group">
                        <label for="default-eye-drops-type">Тип капель по умолчанию</label>
                        <select id="default-eye-drops-type" name="default_eye_drops_type">
                            <option value="Обычные">Обычные</option>
                            <option value="Гелевые">Гелевые</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Чистка зубов</h3>
                    <div class="form-group">
                        <label for="default-tooth-brushing-type">Способ чистки по умолчанию</label>
                        <select id="default-tooth-brushing-type" name="default_tooth_brushing_type">
                            <option value="Щетка">Щетка</option>
                            <option value="Марля">Марля</option>
                            <option value="Игрушка">Игрушка</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Чистка ушей</h3>
                    <div class="form-group">
                        <label for="default-ear-cleaning-type">Способ чистки по умолчанию</label>
                        <select id="default-ear-cleaning-type" name="default_ear_cleaning_type">
                            <option value="Салфетка/Марля">Салфетка/Марля</option>
                            <option value="Капли">Капли</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Настройка тайлов дашборда</h3>
                    <p class="settings-hint">Перетащите тайлы для изменения порядка. Снимите галочку, чтобы скрыть тайл.</p>
                    <div id="tiles-settings-list" class="tiles-settings-list">
                        <!-- Tiles will be dynamically generated here -->
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block">Сохранить настройки</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="resetSettingsToDefaults()">Сбросить к значениям по умолчанию</button>
            </div>
        </form>
    </div>
    
    <!-- Pet Selector Screen -->
    <div id="pet-selector" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Управление питомцами</h2>
        </div>
        <div class="inline-form">
            <div class="form-content">
                <div id="pets-list" class="pets-list">
                    <div class="loading">Загрузка...</div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary btn-block" onclick="resetPetForm(); showScreen('pet-form');">+ Добавить питомца</button>
            </div>
        </div>
    </div>
    
    <!-- Pet Form Screen -->
    <div id="pet-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('pet-selector')">← Назад</button>
            <h2 id="pet-form-title">Добавить питомца</h2>
        </div>
        <form id="pet-form-element" class="inline-form" autocomplete="off">
            <input type="hidden" id="pet-record-id" name="pet_id" value="">
            <div class="form-content">
                <div class="form-group">
                    <label for="pet-name">Имя *</label>
                    <input type="text" id="pet-name" name="name" required placeholder="Саймон" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="pet-breed">Порода</label>
                    <input type="text" id="pet-breed" name="breed" placeholder="Британская короткошерстная" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="pet-birth-date">Дата рождения</label>
                    <input type="date" id="pet-birth-date" name="birth_date" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="pet-gender">Пол</label>
                    <select id="pet-gender" name="gender" autocomplete="off">
                        <option value="">Не указано</option>
                        <option value="Мальчик">Мальчик</option>
                        <option value="Девочка">Девочка</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pet-photo-file">Фото питомца</label>
                    <input type="file" id="pet-photo-file" name="photo_file" accept="image/*">
                    <div id="pet-photo-preview" class="photo-preview-section" style="display: none;">
                        <img id="pet-photo-preview-img" src="" alt="Preview">
                        <button type="button" class="btn btn-secondary btn-small" onclick="clearPetPhoto()">Удалить фото</button>
                    </div>
                    <div id="pet-photo-current" class="photo-current-section" style="display: none;">
                        <h4>Текущее фото</h4>
                        <img id="pet-photo-current-img" src="" alt="Current">
                    </div>
                </div>
                
                <!-- Access Management Section (only when editing) -->
                <div id="pet-access-section" class="sharing-section" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 0.5px solid var(--ios-separator);">
                    <h3>Управление доступом</h3>
                    <div id="pet-shared-with-list" class="shared-list">
                        <div class="loading">Загрузка...</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="share-username-input">Поделиться с пользователем</label>
                        <div class="share-input-group">
                            <input type="text" id="share-username-input" placeholder="Введите имя пользователя" autocomplete="username">
                            <button type="button" class="btn btn-primary" onclick="sharePetFromForm()">Поделиться</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block" id="pet-submit-btn">Сохранить</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="showScreen('pet-selector')">Отмена</button>
            </div>
        </form>
    </div>
    
    <!-- Admin Panel Screen -->
    <div id="admin-panel" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>Админ-панель</h2>
        </div>
        <div class="admin-content">
            <div class="admin-section">
                <h3>Пользователи</h3>
                <button class="btn btn-primary btn-block" onclick="resetUserForm(); showScreen('user-form');">+ Добавить пользователя</button>
                <div id="users-list" class="users-list">
                    <div class="loading">Загрузка...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Form Screen -->
    <div id="user-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('admin-panel')">← Назад</button>
            <h2 id="user-form-title">Добавить пользователя</h2>
        </div>
        <form id="user-form-element" class="inline-form">
            <input type="hidden" id="user-record-username" name="username" value="">
            <div class="form-group">
                <label for="user-username">Имя пользователя *</label>
                <input type="text" id="user-username" name="username" required placeholder="user123" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="user-password" id="user-password-label">Пароль *</label>
                <input type="password" id="user-password" name="password" required placeholder="Введите пароль" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label for="user-full-name">Полное имя</label>
                <input type="text" id="user-full-name" name="full_name" placeholder="Мария Иванова" autocomplete="name">
            </div>
            <div class="form-group">
                <label for="user-email">Email</label>
                <input type="email" id="user-email" name="email" placeholder="email@example.com" autocomplete="email">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block" id="user-submit-btn">Сохранить</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="showScreen('admin-panel')">Отмена</button>
            </div>
        </form>
    </div>
    
    <!-- Pet Sharing Screen -->
    <div id="pet-sharing" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('pet-selector')">← Назад</button>
            <h2>Доступ к животному</h2>
        </div>
        <div class="sharing-content">
            <div id="sharing-info" class="sharing-section">
                <h3>Пользователи с доступом</h3>
                <div id="shared-with-list" class="shared-list">
                    <div class="loading">Загрузка...</div>
                </div>
            </div>
            
            <div id="sharing-owner-section" class="sharing-section" style="display: none;">
                <h3>Поделиться с пользователем</h3>
                <form id="share-form" class="inline-form">
                    <div class="form-group">
                        <label for="share-username">Имя пользователя</label>
                        <input type="text" id="share-username" name="username" required placeholder="Введите имя пользователя" autocomplete="username">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-block">Поделиться</button>
                    </div>
                </form>
            </div>
            
            <div id="sharing-user-section" class="sharing-section" style="display: none;">
                <div class="empty-state">
                    <p>У вас нет доступа к этому животному</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div id="history" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">← Назад</button>
            <h2>История записей</h2>
            <div class="export-buttons">
                <button class="btn btn-secondary btn-small" onclick="showExportMenu()">Выгрузить</button>
            </div>
        </div>
        <div id="export-menu" class="export-menu" style="display: none;" onclick="if(event.target === this) hideExportMenu()">
            <div class="export-menu-content">
                <h3 id="export-menu-title">Выберите тип данных:</h3>
                <div id="export-type-selection" class="export-options">
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('feeding')">Дневные порции</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('weight')">Вес</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('asthma')">Приступы астмы</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('defecation')">Дефекации</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('litter')">Смена лотка</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('eye_drops')">Закапывание глаз</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('tooth_brushing')">Чистка зубов</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('ear_cleaning')">Чистка ушей</button>
                </div>
                <div id="export-format-selection" class="export-options" style="display: none;">
                    <button class="btn btn-secondary btn-block" onclick="exportData('csv')">CSV</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('tsv')">TSV</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('html')">HTML</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('md')">Markdown</button>
                </div>
                <button id="export-back-btn" class="btn btn-primary btn-block" onclick="backToExportType()" style="display: none;">Назад</button>
                <button id="export-cancel-btn" class="btn btn-primary btn-block" onclick="hideExportMenu()">Отмена</button>
            </div>
        </div>
        <div class="history-tabs">
            <button class="tab-btn active" data-tab="feeding" onclick="showHistoryTab('feeding'); return false;">Дневные порции</button>
            <button class="tab-btn" data-tab="weight" onclick="showHistoryTab('weight'); return false;">Вес</button>
            <button class="tab-btn" data-tab="asthma" onclick="showHistoryTab('asthma'); return false;">Приступы астмы</button>
            <button class="tab-btn" data-tab="defecation" onclick="showHistoryTab('defecation'); return false;">Дефекации</button>
            <button class="tab-btn" data-tab="litter" onclick="showHistoryTab('litter'); return false;">Смена лотка</button>
            <button class="tab-btn" data-tab="eye_drops" onclick="showHistoryTab('eye_drops'); return false;">Глаза</button>
            <button class="tab-btn" data-tab="tooth_brushing" onclick="showHistoryTab('tooth_brushing'); return false;">Зубы</button>
            <button class="tab-btn" data-tab="ear_cleaning" onclick="showHistoryTab('ear_cleaning'); return false;">Уши</button>
        </div>
        <div id="history-content" class="history-content">
            <div class="loading">Загрузка...</div>
        </div>
    </div>
    
    <!-- Alert Messages -->
    <div id="alert-container" class="alert-container"></div>
</div>

<script>
// Set default date/time to now and apply saved defaults
function resetFormDefaults() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;
    const timeStr = now.toTimeString().slice(0, 5);
    const settings = getSettings();
    
    // Универсальная установка значений по умолчанию для всех форм
    const formDefaults = {
        feeding: { date: dateStr, time: timeStr },
        asthma: { 
            date: dateStr, 
            time: timeStr,
            duration: settings.asthma.duration,
            inhalation: settings.asthma.inhalation,
            reason: settings.asthma.reason
        },
        defecation: {
            date: dateStr,
            time: timeStr,
            stool_type: settings.defecation.stool_type,
            color: settings.defecation.color || 'Коричневый',
            food: settings.defecation.food
        },
        litter: { date: dateStr, time: timeStr },
        weight: {
            date: dateStr,
            time: timeStr,
            food: settings.weight.food
        },
        'eye_drops': {
            date: dateStr,
            time: timeStr,
            drops_type: settings['eye_drops']?.drops_type || 'Обычные'
        },
        'tooth_brushing': {
            date: dateStr,
            time: timeStr,
            brushing_type: settings['tooth_brushing']?.brushing_type || 'Щетка'
        },
        'ear_cleaning': {
            date: dateStr,
            time: timeStr,
            cleaning_type: settings['ear_cleaning']?.cleaning_type || 'Салфетка/Марля'
        }
    };
    
    // Применяем значения по умолчанию к активным формам
    Object.keys(formDefaults).forEach(formType => {
        const config = FORM_CONFIGS[formType];
        if (!config) return;
        
        config.fields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element && formDefaults[formType][field.name] !== undefined) {
                element.value = formDefaults[formType][field.name];
            }
        });
    });
}

// Close pet switcher menu when clicking outside
document.addEventListener('click', function(event) {
    const switcher = document.getElementById('pet-switcher');
    const menu = document.getElementById('pet-switcher-menu');
    if (switcher && menu && !switcher.contains(event.target)) {
        hidePetSwitcherMenu();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Инициализируем формы при загрузке
    const formTypes = ['feeding', 'asthma', 'defecation', 'litter', 'weight', 'eye_drops', 'tooth_brushing'];
    formTypes.forEach(formType => {
        let containerIdSuffix = formType;
        if (formType === 'eye_drops') {
            containerIdSuffix = 'eye-drops';
        } else if (formType === 'tooth_brushing') {
            containerIdSuffix = 'tooth-brushing';
        }
        const container = document.getElementById(`${containerIdSuffix}-form-container`);
        if (container) {
            container.innerHTML = createFormHTML(formType);
            const form = document.getElementById(`${formType}-form-element`);
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleFormSubmit(formType, form);
                });
            }
        }
    });
    
    resetFormDefaults();
    
    // Инициализируем модули
    PetsModule.init();
    const switcher = document.getElementById('pet-switcher');
    if (switcher) {
        switcher.style.display = 'block';
    }
    
    // Инициализируем статус админа (загрузит из кеша и обновит в фоне)
    UsersModule.init();
    
    // Применить настройки тайлов при загрузке (после инициализации UsersModule)
    if (typeof TilesManager !== 'undefined') {
        TilesManager.applyTilesSettings();
        // Обновить видимость админ-панели после применения настроек
        if (typeof UsersModule !== 'undefined' && UsersModule.updateAdminUI) {
            UsersModule.updateAdminUI();
        }
    }
    
    // Проверяем и выбираем питомца
    PetsModule.checkAndSelectPet().then(() => {
        // checkPetOwnership is deprecated
    });
});

// Deprecated - use UsersModule.checkAdminStatus() instead
async function checkPetOwnership() {
    // This function is no longer needed as sharing is now in pet-selector
    // Keeping it for backward compatibility but it does nothing
}

// User form submission (kept here as it's specific to dashboard)
const userForm = document.getElementById('user-form-element');
if (userForm) {
    userForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const recordUsername = formData.get('username');
        const username = document.getElementById('user-username').value;
        const password = formData.get('password');
        const data = {
            username: username,
            full_name: formData.get('full_name') || '',
            email: formData.get('email') || ''
        };
        
        if (recordUsername) {
            // Update existing user
            if (password) {
                // Reset password if provided
                try {
                    const resetResponse = await fetch(`/api/users/${username}/reset-password`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({password: password})
                    });
                    if (!resetResponse.ok) {
                        const errorData = await resetResponse.json();
                        showAlert('error', errorData.error || 'Ошибка при изменении пароля');
                        return;
                    }
                } catch (error) {
                    showAlert('error', 'Ошибка при изменении пароля');
                    return;
                }
            }
            
            // Update user info
            try {
                const response = await fetch(`/api/users/${username}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showAlert('success', result.message || 'Пользователь обновлен');
                    // Синхронизируем с анимацией: slideIn (0.3s) + небольшая задержка для восприятия
                    const alertAnimationDuration = 300; // slideIn animation duration
                    const perceptionDelay = 300; // время для восприятия сообщения
                    const totalDelay = alertAnimationDuration + perceptionDelay;
                    setTimeout(() => {
                        resetUserForm();
                        showScreen('admin-panel');
                        loadUsersList();
                    }, totalDelay);
                } else {
                    showAlert('error', result.error || 'Ошибка при сохранении');
                }
            } catch (error) {
                showAlert('error', 'Ошибка при сохранении');
            }
        } else {
            // Create new user
            if (!password) {
                showAlert('error', 'Пароль обязателен для нового пользователя');
                return;
            }
            
            data.password = password;
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showAlert('success', result.message || 'Пользователь создан');
                    // Синхронизируем с анимацией: slideIn (0.3s) + небольшая задержка для восприятия
                    const alertAnimationDuration = 300; // slideIn animation duration
                    const perceptionDelay = 300; // время для восприятия сообщения
                    const totalDelay = alertAnimationDuration + perceptionDelay;
                    setTimeout(() => {
                        resetUserForm();
                        showScreen('admin-panel');
                        loadUsersList();
                    }, totalDelay);
                } else {
                    showAlert('error', result.error || 'Ошибка при сохранении');
                }
            } catch (error) {
                showAlert('error', 'Ошибка при сохранении');
            }
        }
    });
}

// Pet sharing functions (специфичные для dashboard - используют элементы HTML dashboard)
// editPet, showPetSharing, sharePetFromForm, loadPetAccessInForm, unsharePetFromForm - теперь в PetsModule

async function loadPetSharing() {
    const petId = getSelectedPetId();
    if (!petId) {
        showAlert('error', 'Выберите животное');
        return;
    }
    
    // Бейдж удален - информация о животном отображается только в навбаре
    
    try {
        const response = await fetch(`/api/pets/${petId}`, {
            credentials: 'include'
        });
        
        if (!response.ok) {
            showAlert('error', 'Ошибка загрузки информации о питомце');
            return;
        }
        
        const data = await response.json();
        const pet = data.pet;
        
        // Check if current user is owner (from API response)
        const userIsOwner = pet.current_user_is_owner || false;
        const sharedWith = pet.shared_with || [];
        // User has access if they can see this screen (they're owner or in shared_with)
        const hasAccess = userIsOwner || sharedWith.length >= 0; // Always true if they reached this screen
        
        // Show/hide sections
        document.getElementById('sharing-owner-section').style.display = userIsOwner ? 'block' : 'none';
        document.getElementById('sharing-user-section').style.display = hasAccess ? 'none' : 'block';
        
        // Load shared users
        if (hasAccess) {
            await loadSharedWithList(pet);
        }
    } catch (error) {
        showAlert('error', 'Ошибка загрузки данных');
        console.error('Error:', error);
    }
}

async function loadSharedWithList(pet) {
    const container = document.getElementById('shared-with-list');
    const sharedWith = pet.shared_with || [];
    
    if (sharedWith.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>Нет пользователей с доступом</p></div>';
        return;
    }
    
        let html = '<div class="shared-users-list">';
        sharedWith.forEach(username => {
            html += `
                <div class="shared-user-item">
                    <div class="shared-user-name">${username}</div>
                    ${pet.current_user_is_owner ? `
                    <div class="shared-user-actions">
                        <button class="btn btn-secondary btn-block" onclick="unsharePet('${username}')">Убрать доступ</button>
                    </div>
                    ` : ''}
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
}

async function sharePetWithUser(username) {
    const petId = getSelectedPetId();
    if (!petId) {
        showAlert('error', 'Выберите животное в меню навигации');
        return;
    }
    
    try {
        const response = await fetch(`/api/pets/${petId}/share`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({username: username})
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || 'Доступ предоставлен');
            document.getElementById('share-form').reset();
            loadPetSharing();
        } else {
            showAlert('error', result.error || 'Ошибка при предоставлении доступа');
        }
    } catch (error) {
        showAlert('error', 'Ошибка при предоставлении доступа');
    }
}

async function unsharePet(username) {
    const petId = getSelectedPetId();
    if (!petId) {
        return;
    }
    
    if (!confirm(`Убрать доступ у пользователя ${username}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/pets/${petId}/share/${username}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || 'Доступ убран');
            loadPetSharing();
        } else {
            showAlert('error', result.error || 'Ошибка при удалении доступа');
        }
    } catch (error) {
        showAlert('error', 'Ошибка при удалении доступа');
    }
}

// Share form submission
document.getElementById('share-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const username = formData.get('username').trim();
    
    if (!username) {
        showAlert('error', 'Введите имя пользователя');
        return;
    }
    
    await sharePetWithUser(username);
});

// Pet photo file input handler
document.getElementById('pet-photo-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('pet-photo-preview');
    const previewImg = document.getElementById('pet-photo-preview-img');
    const photoCurrent = document.getElementById('pet-photo-current');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            previewImg.style.display = 'block';
            // Hide current photo when new photo is selected
            if (photoCurrent) {
                photoCurrent.style.display = 'none';
            }
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
});

function clearPetPhoto() {
    document.getElementById('pet-photo-file').value = '';
    document.getElementById('pet-photo-preview').style.display = 'none';
    // Mark photo for removal
    const form = document.getElementById('pet-form-element');
    const removeInput = document.createElement('input');
    removeInput.type = 'hidden';
    removeInput.name = 'remove_photo';
    removeInput.value = 'true';
    form.appendChild(removeInput);
}

// Pet form submission
document.getElementById('pet-form-element').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const recordId = formData.get('pet_id');
    
    try {
        const url = recordId ? `/api/pets/${recordId}` : '/api/pets';
        const method = recordId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            credentials: 'include',
            body: formData
        });
        
        let result;
        try {
            result = await response.json();
        } catch (jsonError) {
            console.error('Error parsing JSON response:', jsonError);
            showAlert('error', 'Ошибка при обработке ответа сервера');
            return;
        }
        
        if (response.ok) {
            showAlert('success', result.message || (recordId ? 'Питомец обновлен' : 'Питомец создан'));
            
            // If new pet created, set it as selected
            if (!recordId && result.pet && result.pet._id && result.pet.name) {
                try {
                    setSelectedPet(result.pet._id, result.pet.name);
                } catch (selectError) {
                    console.error('Error setting selected pet:', selectError);
                }
            }
            
            // Reload pets list to show updated data
            try {
                await renderPetsList();
            } catch (renderError) {
                console.error('Error rendering pets list:', renderError);
            }
            
            // Синхронизируем с анимацией: fadeIn (0.3s) + небольшая задержка для восприятия
            const alertAnimationDuration = 300; // fadeIn animation duration (совпадает с экранами)
            const screenTransitionDuration = 300; // fadeIn animation duration (--duration-slow)
            const perceptionDelay = 300; // время для восприятия сообщения
            const totalDelay = alertAnimationDuration + perceptionDelay;
            
            // Reset form and return to pet selector screen after animation completes
            setTimeout(() => {
                resetPetForm();
                showScreen('pet-selector');
            }, totalDelay);
        } else {
            showAlert('error', result.error || result);
        }
    } catch (error) {
        console.error('Error submitting pet form:', error);
        showAlert('error', 'Ошибка при сохранении: ' + (error.message || 'Неизвестная ошибка'));
    }
});

function resetPetForm() {
    document.getElementById('pet-form-element').reset();
    document.getElementById('pet-record-id').value = '';
    document.getElementById('pet-form-title').textContent = 'Добавить питомца';
    document.getElementById('pet-submit-btn').textContent = 'Сохранить';
    const preview = document.getElementById('pet-photo-preview');
    const previewImg = document.getElementById('pet-photo-preview-img');
    if (preview) {
        preview.style.display = 'none';
        if (previewImg) {
            previewImg.src = '';
        }
    }
    const photoCurrent = document.getElementById('pet-photo-current');
    if (photoCurrent) {
        photoCurrent.style.display = 'none';
    }
    document.getElementById('pet-access-section').style.display = 'none';
}

// Form submissions - теперь обрабатываются универсальным handleFormSubmit в forms-config.js
// Старые обработчики удалены для сокращения кода (~260 строк удалено)

// Settings form submission
document.getElementById('settings-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const settings = {
        asthma: {
            duration: document.getElementById('default-asthma-duration').value,
            inhalation: document.getElementById('default-asthma-inhalation').value,
            reason: document.getElementById('default-asthma-reason').value
        },
        defecation: {
            stool_type: document.getElementById('default-defecation-stool-type').value,
            color: document.getElementById('default-defecation-color').value,
            food: document.getElementById('default-defecation-food').value
        },
        weight: {
            food: document.getElementById('default-weight-food').value
        },
        'eye_drops': {
            drops_type: document.getElementById('default-eye-drops-type').value
        },
        'tooth_brushing': {
            brushing_type: document.getElementById('default-tooth-brushing-type').value
        },
        'ear_cleaning': {
            cleaning_type: document.getElementById('default-ear-cleaning-type').value
        }
    };
    
    saveSettings(settings);
    
    // Сохранить настройки тайлов
    if (typeof TilesManager !== 'undefined') {
        TilesManager.saveTilesSettingsFromForm();
        // Применить настройки тайлов к дашборду
        TilesManager.applyTilesSettings();
    }
    
    showAlert('success', 'Настройки сохранены');
    setTimeout(() => {
        showScreen('main-menu');
    }, 500);
});

function showAlert(type, message) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    
    // Handle Pydantic error format (list of errors)
    if (type === 'error' && Array.isArray(message)) {
        if (message.length > 0) {
            const err = message[0];
            const loc = err.loc ? err.loc.join('.') : '';
            const msg = err.msg || 'Ошибка валидации';
            alert.textContent = loc ? `${loc}: ${msg}` : msg;
        } else {
            alert.textContent = 'Неизвестная ошибка валидации';
        }
    } else {
        alert.textContent = message;
    }
    
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

async function editRecord(type, recordId) {
    const petId = getSelectedPetId();
    if (!petId) {
        showAlert('error', 'Выберите животное в меню навигации');
        return;
    }
    
    let endpoint;
    if (type === 'feeding') {
        endpoint = `/api/feeding?pet_id=${petId}`;
    } else if (type === 'asthma') {
        endpoint = `/api/asthma?pet_id=${petId}`;
    } else if (type === 'defecation') {
        endpoint = `/api/defecation?pet_id=${petId}`;
    } else if (type === 'litter') {
        endpoint = `/api/litter?pet_id=${petId}`;
    } else if (type === 'eye_drops') {
        endpoint = `/api/eye_drops?pet_id=${petId}`;
    } else if (type === 'tooth_brushing') {
        endpoint = `/api/tooth_brushing?pet_id=${petId}`;
    } else if (type === 'ear_cleaning') {
        endpoint = `/api/ear_cleaning?pet_id=${petId}`;
    } else {
        endpoint = `/api/weight?pet_id=${petId}`;
    }
    
    try {
        const response = await fetch(endpoint, {
            credentials: 'include'
        });
        const data = await response.json();
        let items;
        if (type === 'feeding') {
            items = data.feedings;
        } else if (type === 'asthma') {
            items = data.attacks;
        } else if (type === 'defecation') {
            items = data.defecations;
        } else if (type === 'litter') {
            items = data.litter_changes;
        } else if (type === 'eye_drops') {
            items = data['eye_drops'];
        } else if (type === 'tooth_brushing') {
            items = data['tooth_brushing'];
        } else if (type === 'ear_cleaning') {
            items = data['ear_cleaning'];
        } else {
            items = data.weights;
        }
        const record = items.find(item => item._id === recordId);
        
        if (!record) {
            // Record was deleted by another user (race condition)
            showAlert('info', 'Запись была удалена другим пользователем. История обновлена.');
            // Refresh history to remove the deleted record from UI
            showHistoryTab(type);
            return;
        }
        
        // Используем универсальную функцию заполнения формы
        // Преобразуем данные для совместимости
        const formRecord = { ...record };
        if (type === 'asthma' && record.inhalation === 'Да') {
            formRecord.inhalation = 'true';
        } else if (type === 'asthma' && record.inhalation === 'Нет') {
            formRecord.inhalation = 'false';
        }
        
        populateForm(type, formRecord, recordId);
        let screenId;
        if (type === 'eye_drops') {
            screenId = 'eye-drops-form';
        } else if (type === 'tooth_brushing') {
            screenId = 'tooth-brushing-form';
        } else if (type === 'ear_cleaning') {
            screenId = 'ear-cleaning-form';
        } else {
            screenId = `${type}-form`;
        }
        showScreen(screenId);
    } catch (error) {
        showAlert('error', 'Ошибка при загрузке записи');
        console.error('Error:', error);
    }
}

async function deleteRecord(type, recordId) {
    if (!confirm('Вы уверены, что хотите удалить эту запись?')) {
        return;
    }

    // Find the element to remove (for preserving scroll position)
    const historyItem = document.querySelector(`.history-item[data-id="${recordId}"]`);
    const historyList = historyItem?.parentElement;
    const historyContent = document.getElementById('history-content');

    const endpoint = `/api/${type}/${recordId}`;

    try {
        const response = await fetch(endpoint, {
            method: 'DELETE',
            credentials: 'include'
        });

        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || 'Запись удалена');
            
            // Remove element from DOM to preserve scroll position
            if (historyItem && historyList) {
                historyItem.remove();
                
                // Update pagination total
                if (typeof HistoryModule !== 'undefined' && HistoryModule.pagination) {
                    HistoryModule.pagination.total = Math.max(0, HistoryModule.pagination.total - 1);
                    HistoryModule.pagination.hasMore = (HistoryModule.pagination.currentPage * HistoryModule.pagination.pageSize) < HistoryModule.pagination.total;
                    
                    // Update pagination controls
                    if (historyContent) {
                        HistoryModule.updatePaginationControls(historyContent, type);
                    }
                }
                
                // If list is now empty, show "no data" message
                const remainingItems = historyList.querySelectorAll('.history-item');
                if (remainingItems.length === 0 && historyContent) {
                    historyContent.innerHTML = '<p class="no-data">Нет записей</p>';
                }
            } else {
                // Fallback: reload if element not found
                showHistoryTab(type);
            }
        } else if (response.status === 404) {
            // Record already deleted (race condition: another user deleted it)
            showAlert('info', 'Запись уже была удалена');
            
            // Remove element from DOM if it exists
            if (historyItem && historyList) {
                historyItem.remove();
                
                // Update pagination total
                if (typeof HistoryModule !== 'undefined' && HistoryModule.pagination) {
                    HistoryModule.pagination.total = Math.max(0, HistoryModule.pagination.total - 1);
                    HistoryModule.pagination.hasMore = (HistoryModule.pagination.currentPage * HistoryModule.pagination.pageSize) < HistoryModule.pagination.total;
                    
                    // Update pagination controls
                    if (historyContent) {
                        HistoryModule.updatePaginationControls(historyContent, type);
                    }
                }
                
                const remainingItems = historyList.querySelectorAll('.history-item');
                if (remainingItems.length === 0 && historyContent) {
                    historyContent.innerHTML = '<p class="no-data">Нет записей</p>';
                }
            } else {
                // Fallback: reload if element not found
                showHistoryTab(type);
            }
        } else {
            showAlert('error', result.error || 'Ошибка при удалении');
        }
    } catch (error) {
        showAlert('error', 'Ошибка при удалении');
        console.error('Error:', error);
    }
}
</script>
{% endblock %}
