{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - Cat Health Control{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Main Menu -->
    <div id="main-menu" class="screen active">
        <div class="welcome-section">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ username }}!</h2>
            <p>–°–ª–µ–¥–∏–º –∑–∞ –∑–¥–æ—Ä–æ–≤—å–µ–º –°–∞–π–º–æ–Ω—á–∏–∫–∞ üê±</p>
        </div>
        
        <div class="action-cards">
            <div class="card action-card action-card-asthma" onclick="showScreen('asthma-form')">
                <h3>–ü—Ä–∏—Å—Ç—É–ø –∞—Å—Ç–º—ã</h3>
                <p>–ó–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏—Å—Ç—É–ø</p>
            </div>
            
            <div class="card action-card action-card-defecation" onclick="showScreen('defecation-form')">
                <h3>–î–µ—Ñ–µ–∫–∞—Ü–∏—è</h3>
                <p>–ó–∞–ø–∏—Å–∞—Ç—å –¥–µ—Ñ–µ–∫–∞—Ü–∏—é</p>
            </div>
            
            <div class="card action-card action-card-weight" onclick="showScreen('weight-form')">
                <h3>–í–µ—Å</h3>
                <p>–ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å</p>
            </div>
            
            <div class="card action-card action-card-history" onclick="showScreen('history')">
                <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π</p>
            </div>
            
            <div class="card action-card action-card-settings" onclick="showScreen('settings')">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <p>–ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</p>
            </div>
        </div>
    </div>
    
    <!-- Asthma Form -->
    <div id="asthma-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ó–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏—Å—Ç—É–ø –∞—Å—Ç–º—ã</h2>
        </div>
        <form id="asthma-form-element" class="inline-form">
            <input type="hidden" id="asthma-record-id" name="record_id" value="">
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="asthma-date">–î–∞—Ç–∞</label>
                    <input type="date" id="asthma-date" name="date" required>
                </div>
                <div class="form-group form-group-half">
                    <label for="asthma-time">–í—Ä–µ–º—è</label>
                    <input type="time" id="asthma-time" name="time" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="asthma-duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                    <select id="asthma-duration" name="duration" required>
                        <option value="–ö–æ—Ä–æ—Ç–∫–∏–π" selected>–ö–æ—Ä–æ—Ç–∫–∏–π</option>
                        <option value="–î–ª–∏—Ç–µ–ª—å–Ω—ã–π">–î–ª–∏—Ç–µ–ª—å–Ω—ã–π</option>
                    </select>
                </div>
                <div class="form-group form-group-half">
                    <label for="asthma-inhalation">–ò–Ω–≥–∞–ª—è—Ü–∏—è</label>
                    <select id="asthma-inhalation" name="inhalation" required>
                        <option value="false" selected>–ù–µ—Ç</option>
                        <option value="true">–î–∞</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="asthma-reason">–ü—Ä–∏—á–∏–Ω–∞</label>
                <input type="text" id="asthma-reason" name="reason" value="–ü–∏–ª" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∏–ª –ø–æ—Å–ª–µ —Å–Ω–∞" required>
            </div>
            <div class="form-group">
                <label for="asthma-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="asthma-comment" name="comment" rows="2"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block" id="asthma-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
    
    <!-- Defecation Form -->
    <div id="defecation-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ó–∞–ø–∏—Å–∞—Ç—å –¥–µ—Ñ–µ–∫–∞—Ü–∏—é</h2>
        </div>
        <form id="defecation-form-element" class="inline-form">
            <input type="hidden" id="defecation-record-id" name="record_id" value="">
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="defecation-date">–î–∞—Ç–∞</label>
                    <input type="date" id="defecation-date" name="date" required>
                </div>
                <div class="form-group form-group-half">
                    <label for="defecation-time">–í—Ä–µ–º—è</label>
                    <input type="time" id="defecation-time" name="time" required>
                </div>
            </div>
            <div class="form-group">
                <label for="defecation-stool-type">–¢–∏–ø —Å—Ç—É–ª–∞</label>
                <select id="defecation-stool-type" name="stool_type" required>
                    <option value="–û–±—ã—á–Ω—ã–π" selected>–û–±—ã—á–Ω—ã–π</option>
                    <option value="–¢–≤–µ—Ä–¥—ã–π">–¢–≤–µ—Ä–¥—ã–π</option>
                    <option value="–ñ–∏–¥–∫–∏–π">–ñ–∏–¥–∫–∏–π</option>
                </select>
            </div>
            <div class="form-group">
                <label for="defecation-color">–¶–≤–µ—Ç —Å—Ç—É–ª–∞</label>
                <select id="defecation-color" name="color" required>
                    <option value="–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π" selected>–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                    <option value="–¢–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π">–¢–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                    <option value="–°–≤–µ—Ç–ª–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π">–°–≤–µ—Ç–ª–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                    <option value="–î—Ä—É–≥–æ–π">–î—Ä—É–≥–æ–π</option>
                </select>
            </div>
            <div class="form-group">
                <label for="defecation-food">–ö–æ—Ä–º</label>
                <input type="text" id="defecation-food" name="food" value="Royal Canin Fibre Response" placeholder="Royal Canin Fibre Response">
            </div>
            <div class="form-group">
                <label for="defecation-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="defecation-comment" name="comment" rows="2"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block" id="defecation-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
    
    <!-- Weight Form -->
    <div id="weight-form" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å</h2>
        </div>
        <form id="weight-form-element" class="inline-form">
            <input type="hidden" id="weight-record-id" name="record_id" value="">
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="weight-date">–î–∞—Ç–∞</label>
                    <input type="date" id="weight-date" name="date" required>
                </div>
                <div class="form-group form-group-half">
                    <label for="weight-time">–í—Ä–µ–º—è</label>
                    <input type="time" id="weight-time" name="time" required>
                </div>
            </div>
            <div class="form-group">
                <label for="weight-value">–í–µ—Å (–∫–≥)</label>
                <input type="number" id="weight-value" name="weight" step="0.01" min="0" max="20" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4.5" required>
            </div>
            <div class="form-group">
                <label for="weight-food">–ö–æ—Ä–º</label>
                <input type="text" id="weight-food" name="food" value="Royal Canin Fibre Response" placeholder="Royal Canin Fibre Response">
            </div>
            <div class="form-group">
                <label for="weight-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="weight-comment" name="comment" rows="2"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block" id="weight-submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
    
    <!-- Settings Screen -->
    <div id="settings" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</h2>
        </div>
        <form id="settings-form" class="inline-form">
            <div class="settings-section">
                <h3>–ü—Ä–∏—Å—Ç—É–ø –∞—Å—Ç–º—ã</h3>
                <div class="form-group">
                    <label for="default-asthma-duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                    <select id="default-asthma-duration" name="default_asthma_duration">
                        <option value="–ö–æ—Ä–æ—Ç–∫–∏–π">–ö–æ—Ä–æ—Ç–∫–∏–π</option>
                        <option value="–î–ª–∏—Ç–µ–ª—å–Ω—ã–π">–î–ª–∏—Ç–µ–ª—å–Ω—ã–π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="default-asthma-inhalation">–ò–Ω–≥–∞–ª—è—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                    <select id="default-asthma-inhalation" name="default_asthma_inhalation">
                        <option value="false">–ù–µ—Ç</option>
                        <option value="true">–î–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="default-asthma-reason">–ü—Ä–∏—á–∏–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                    <input type="text" id="default-asthma-reason" name="default_asthma_reason" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∏–ª">
                </div>
            </div>
            
            <div class="settings-section">
                <h3>–î–µ—Ñ–µ–∫–∞—Ü–∏—è</h3>
                <div class="form-group">
                    <label for="default-defecation-stool-type">–¢–∏–ø —Å—Ç—É–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                    <select id="default-defecation-stool-type" name="default_defecation_stool_type">
                        <option value="–û–±—ã—á–Ω—ã–π">–û–±—ã—á–Ω—ã–π</option>
                        <option value="–¢–≤–µ—Ä–¥—ã–π">–¢–≤–µ—Ä–¥—ã–π</option>
                        <option value="–ñ–∏–¥–∫–∏–π">–ñ–∏–¥–∫–∏–π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="default-defecation-color">–¶–≤–µ—Ç —Å—Ç—É–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                    <select id="default-defecation-color" name="default_defecation_color">
                        <option value="–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π">–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                        <option value="–¢–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π">–¢–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                        <option value="–°–≤–µ—Ç–ª–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π">–°–≤–µ—Ç–ª–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
                        <option value="–î—Ä—É–≥–æ–π">–î—Ä—É–≥–æ–π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="default-defecation-food">–ö–æ—Ä–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                    <input type="text" id="default-defecation-food" name="default_defecation_food" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Royal Canin Fibre Response">
                </div>
            </div>
            
            <div class="settings-section">
                <h3>–í–µ—Å</h3>
                <div class="form-group">
                    <label for="default-weight-food">–ö–æ—Ä–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                    <input type="text" id="default-weight-food" name="default_weight_food" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Royal Canin Fibre Response">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-block">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="resetSettingsToDefaults()">–°–±—Ä–æ—Å–∏—Ç—å –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
            </div>
        </form>
    </div>
    
    <!-- History Screen -->
    <div id="history" class="screen">
        <div class="form-header">
            <button class="back-btn" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
            <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</h2>
            <div class="export-buttons">
                <button class="btn btn-secondary btn-small" onclick="showExportMenu()">–í—ã–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
        <div id="export-menu" class="export-menu" style="display: none;" onclick="if(event.target === this) hideExportMenu()">
            <div class="export-menu-content">
                <h3 id="export-menu-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö:</h3>
                <div id="export-type-selection" class="export-options">
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('asthma')">–ü—Ä–∏—Å—Ç—É–ø—ã –∞—Å—Ç–º—ã</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('defecation')">–î–µ—Ñ–µ–∫–∞—Ü–∏–∏</button>
                    <button class="btn btn-secondary btn-block" onclick="selectExportType('weight')">–í–µ—Å</button>
                </div>
                <div id="export-format-selection" class="export-options" style="display: none;">
                    <button class="btn btn-secondary btn-block" onclick="exportData('csv')">CSV</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('tsv')">TSV</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('html')">HTML</button>
                    <button class="btn btn-secondary btn-block" onclick="exportData('md')">Markdown</button>
                    <button class="btn btn-secondary btn-block" onclick="backToExportType()">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
                <button id="export-cancel-btn" class="btn btn-secondary btn-block" onclick="hideExportMenu()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div class="history-tabs">
            <button class="tab-btn active" data-tab="asthma" onclick="showHistoryTab('asthma'); return false;">–ü—Ä–∏—Å—Ç—É–ø—ã –∞—Å—Ç–º—ã</button>
            <button class="tab-btn" data-tab="defecation" onclick="showHistoryTab('defecation'); return false;">–î–µ—Ñ–µ–∫–∞—Ü–∏–∏</button>
            <button class="tab-btn" data-tab="weight" onclick="showHistoryTab('weight'); return false;">–í–µ—Å</button>
        </div>
        <div id="history-content" class="history-content">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
    
    <!-- Alert Messages -->
    <div id="alert-container" class="alert-container"></div>
</div>

<script>
// Default settings
const DEFAULT_SETTINGS = {
    asthma: {
        duration: '–ö–æ—Ä–æ—Ç–∫–∏–π',
        inhalation: 'false',
        reason: '–ü–∏–ª'
    },
    defecation: {
        stool_type: '–û–±—ã—á–Ω—ã–π',
        color: '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π',
        food: 'Royal Canin Fibre Response'
    },
    weight: {
        food: 'Royal Canin Fibre Response'
    }
};

// Load settings from localStorage
function loadSettings() {
    const saved = localStorage.getItem('formDefaults');
    if (saved) {
        try {
            const settings = JSON.parse(saved);
            // Ensure backward compatibility - add color if missing
            if (settings.defecation && !settings.defecation.color) {
                settings.defecation.color = '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π';
            }
            return settings;
        } catch (e) {
            console.error('Error loading settings:', e);
        }
    }
    return DEFAULT_SETTINGS;
}

// Save settings to localStorage
function saveSettings(settings) {
    localStorage.setItem('formDefaults', JSON.stringify(settings));
}

// Get current settings
function getSettings() {
    return loadSettings();
}

// Set default date/time to now and apply saved defaults
function resetFormDefaults() {
    const now = new Date();
    const dateStr = now.toISOString().split('T')[0];
    const timeStr = now.toTimeString().slice(0, 5);
    const settings = getSettings();
    
    // Asthma form
    document.getElementById('asthma-date').value = dateStr;
    document.getElementById('asthma-time').value = timeStr;
    document.getElementById('asthma-duration').value = settings.asthma.duration;
    document.getElementById('asthma-inhalation').value = settings.asthma.inhalation;
    document.getElementById('asthma-reason').value = settings.asthma.reason;
    
    // Defecation form
    document.getElementById('defecation-date').value = dateStr;
    document.getElementById('defecation-time').value = timeStr;
    document.getElementById('defecation-stool-type').value = settings.defecation.stool_type;
    document.getElementById('defecation-color').value = settings.defecation.color || '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π';
    document.getElementById('defecation-food').value = settings.defecation.food;
    
    // Weight form
    document.getElementById('weight-date').value = dateStr;
    document.getElementById('weight-time').value = timeStr;
    document.getElementById('weight-food').value = settings.weight.food;
}

// Load settings into settings form
function loadSettingsForm() {
    const settings = getSettings();
    document.getElementById('default-asthma-duration').value = settings.asthma.duration;
    document.getElementById('default-asthma-inhalation').value = settings.asthma.inhalation;
    document.getElementById('default-asthma-reason').value = settings.asthma.reason;
    document.getElementById('default-defecation-stool-type').value = settings.defecation.stool_type;
    document.getElementById('default-defecation-color').value = settings.defecation.color || '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π';
    document.getElementById('default-defecation-food').value = settings.defecation.food;
    document.getElementById('default-weight-food').value = settings.weight.food;
}

// Reset settings to defaults
function resetSettingsToDefaults() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
        saveSettings(DEFAULT_SETTINGS);
        loadSettingsForm();
        showAlert('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    resetFormDefaults();
});

function showScreen(screenId) {
    // Hide all screens
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    // Show selected screen
    const screen = document.getElementById(screenId);
    if (screen) {
        screen.classList.add('active');
        // Scroll to top
        window.scrollTo(0, 0);
        
        // Reset form defaults if showing a form screen
        if (screenId === 'asthma-form' && !document.getElementById('asthma-record-id').value) {
            resetFormDefaults();
            document.getElementById('asthma-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        } else if (screenId === 'defecation-form' && !document.getElementById('defecation-record-id').value) {
            resetFormDefaults();
            document.getElementById('defecation-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        } else if (screenId === 'weight-form' && !document.getElementById('weight-record-id').value) {
            resetFormDefaults();
            document.getElementById('weight-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        } else if (screenId === 'settings') {
            loadSettingsForm();
        } else if (screenId === 'history') {
            // Load default tab when opening history
            showHistoryTab('asthma');
        }
    }
}


let currentHistoryType = 'asthma';
let selectedExportType = null;

function showExportMenu() {
    selectedExportType = null;
    document.getElementById('export-type-selection').style.display = 'block';
    document.getElementById('export-format-selection').style.display = 'none';
    document.getElementById('export-menu-title').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö:';
    document.getElementById('export-menu').style.display = 'flex';
}

function hideExportMenu() {
    document.getElementById('export-menu').style.display = 'none';
    selectedExportType = null;
}

function selectExportType(type) {
    selectedExportType = type;
    document.getElementById('export-type-selection').style.display = 'none';
    document.getElementById('export-format-selection').style.display = 'block';
    document.getElementById('export-cancel-btn').style.display = 'none';
    const typeName = type === 'asthma' ? '–ü—Ä–∏—Å—Ç—É–ø—ã –∞—Å—Ç–º—ã' : (type === 'defecation' ? '–î–µ—Ñ–µ–∫–∞—Ü–∏–∏' : '–í–µ—Å');
    document.getElementById('export-menu-title').textContent = `–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç (${typeName}):`;
}

function backToExportType() {
    selectedExportType = null;
    document.getElementById('export-type-selection').style.display = 'block';
    document.getElementById('export-format-selection').style.display = 'none';
    document.getElementById('export-cancel-btn').style.display = 'block';
    document.getElementById('export-menu-title').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö:';
}

async function exportData(format) {
    if (!selectedExportType) {
        showAlert('error', '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö');
        return;
    }
    
    const url = `/api/export/${selectedExportType}/${format}`;
    
    try {
        const response = await fetch(url, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ' }));
            showAlert('error', errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ');
            return;
        }
        
        // Get filename from Content-Disposition header or generate one
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = '';
        if (contentDisposition) {
            // Try RFC 5987 format first: filename*=UTF-8''encoded-name
            const rfc5987Match = contentDisposition.match(/filename\*=UTF-8''(.+)/);
            if (rfc5987Match) {
                filename = decodeURIComponent(rfc5987Match[1]);
            } else {
                // Fallback to standard format
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
        }
        
        if (!filename) {
            const typeName = selectedExportType === 'asthma' ? 'asthma' : 'defecation';
            filename = `${typeName}_${new Date().toISOString().slice(0, 10)}.${format}`;
        }
        
        // Create blob and download
        const blob = await response.blob();
        const blobUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(blobUrl);
        
        hideExportMenu();
        showAlert('success', '–§–∞–π–ª –≤—ã–≥—Ä—É–∂–µ–Ω');
    } catch (error) {
        console.error('Export error:', error);
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
    }
}

function showHistoryTab(type) {
    currentHistoryType = type;
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        const isAsthma = type === 'asthma' && btn.textContent.includes('–∞—Å—Ç–º—ã');
        const isDefecation = type === 'defecation' && btn.textContent.includes('–î–µ—Ñ–µ–∫–∞—Ü–∏–∏');
        const isWeight = type === 'weight' && btn.textContent.includes('–í–µ—Å');
        if (isAsthma || isDefecation || isWeight) {
            btn.classList.add('active');
        }
    });
    
    const content = document.getElementById('history-content');
    content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    const endpoint = type === 'asthma' ? '/api/asthma' : (type === 'defecation' ? '/api/defecation' : '/api/weight');
    
    fetch(endpoint, { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
            const items = type === 'asthma' ? data.attacks : (type === 'defecation' ? data.defecations : data.weights);
            
            if (items.length === 0) {
                content.innerHTML = '<p class="no-data">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
                return;
            }
            
            let html = '<div class="history-list">';
            items.forEach(item => {
                html += `<div class="history-item history-item-${type}" data-id="${item._id}">`;
                html += `<div class="history-date">${item.date_time}</div>`;
                if (type === 'asthma') {
                    html += `<div class="history-details">`;
                    html += `<span><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${item.duration}</span>`;
                    html += `<span><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${item.reason}</span>`;
                    html += `<span><strong>–ò–Ω–≥–∞–ª—è—Ü–∏—è:</strong> ${item.inhalation}</span>`;
                    if (item.comment && item.comment !== '-') {
                        html += `<span><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${item.comment}</span>`;
                    }
                    html += `</div>`;
                } else if (type === 'defecation') {
                    html += `<div class="history-details">`;
                    html += `<span><strong>–¢–∏–ø —Å—Ç—É–ª–∞:</strong> ${item.stool_type}</span>`;
                    if (item.color) {
                        html += `<span><strong>–¶–≤–µ—Ç —Å—Ç—É–ª–∞:</strong> ${item.color}</span>`;
                    }
                    if (item.food && item.food !== '-') {
                        html += `<span><strong>–ö–æ—Ä–º:</strong> ${item.food}</span>`;
                    }
                    if (item.comment && item.comment !== '-') {
                        html += `<span><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${item.comment}</span>`;
                    }
                    html += `</div>`;
                } else if (type === 'weight') {
                    html += `<div class="history-details">`;
                    html += `<span><strong>–í–µ—Å:</strong> ${item.weight} –∫–≥</span>`;
                    if (item.food && item.food !== '-') {
                        html += `<span><strong>–ö–æ—Ä–º:</strong> ${item.food}</span>`;
                    }
                    if (item.comment && item.comment !== '-') {
                        html += `<span><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${item.comment}</span>`;
                    }
                    html += `</div>`;
                }
                html += `<div class="history-actions">`;
                html += `<button class="btn btn-secondary btn-small" onclick="editRecord('${type}', '${item._id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;
                html += `<button class="btn btn-secondary btn-small" onclick="deleteRecord('${type}', '${item._id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                html += `</div>`;
                html += '</div>';
            });
            html += '</div>';
            content.innerHTML = html;
        })
        .catch(error => {
            content.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            console.error('Error:', error);
        });
}

// Form submissions
document.getElementById('asthma-form-element').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const recordId = formData.get('record_id');
    const data = {
        date: formData.get('date'),
        time: formData.get('time'),
        duration: formData.get('duration'),
        reason: formData.get('reason'),
        inhalation: formData.get('inhalation') === 'true',
        comment: formData.get('comment') || ''
    };
    
    try {
        const url = recordId ? `/api/asthma/${recordId}` : '/api/asthma';
        const method = recordId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || (recordId ? '–ü—Ä–∏—Å—Ç—É–ø –∞—Å—Ç–º—ã –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ü—Ä–∏—Å—Ç—É–ø –∞—Å—Ç–º—ã –∑–∞–ø–∏—Å–∞–Ω'));
            document.getElementById('asthma-form-element').reset();
            document.getElementById('asthma-record-id').value = '';
            document.getElementById('asthma-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            resetFormDefaults();
            setTimeout(() => {
                showScreen('main-menu');
                if (recordId) {
                    showScreen('history');
                    showHistoryTab('asthma');
                }
            }, 150);
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
});

document.getElementById('defecation-form-element').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const recordId = formData.get('record_id');
    const data = {
        date: formData.get('date'),
        time: formData.get('time'),
        stool_type: formData.get('stool_type'),
        color: formData.get('color'),
        food: formData.get('food') || '',
        comment: formData.get('comment') || ''
    };
    
    try {
        const url = recordId ? `/api/defecation/${recordId}` : '/api/defecation';
        const method = recordId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || (recordId ? '–î–µ—Ñ–µ–∫–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞' : '–î–µ—Ñ–µ–∫–∞—Ü–∏—è –∑–∞–ø–∏—Å–∞–Ω–∞'));
            document.getElementById('defecation-form-element').reset();
            document.getElementById('defecation-record-id').value = '';
            document.getElementById('defecation-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            resetFormDefaults();
            setTimeout(() => {
                showScreen('main-menu');
                if (recordId) {
                    showScreen('history');
                    showHistoryTab('defecation');
                }
            }, 150);
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
});

document.getElementById('weight-form-element').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const recordId = formData.get('record_id');
    const data = {
        date: formData.get('date'),
        time: formData.get('time'),
        weight: formData.get('weight'),
        food: formData.get('food') || '',
        comment: formData.get('comment') || ''
    };
    
    try {
        const url = recordId ? `/api/weight/${recordId}` : '/api/weight';
        const method = recordId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || (recordId ? '–í–µ—Å –æ–±–Ω–æ–≤–ª–µ–Ω' : '–í–µ—Å –∑–∞–ø–∏—Å–∞–Ω'));
            document.getElementById('weight-form-element').reset();
            document.getElementById('weight-record-id').value = '';
            document.getElementById('weight-submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            resetFormDefaults();
            setTimeout(() => {
                showScreen('main-menu');
                if (recordId) {
                    showScreen('history');
                    showHistoryTab('weight');
                }
            }, 150);
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
});

// Settings form submission
document.getElementById('settings-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const settings = {
        asthma: {
            duration: document.getElementById('default-asthma-duration').value,
            inhalation: document.getElementById('default-asthma-inhalation').value,
            reason: document.getElementById('default-asthma-reason').value
        },
        defecation: {
            stool_type: document.getElementById('default-defecation-stool-type').value,
            color: document.getElementById('default-defecation-color').value,
            food: document.getElementById('default-defecation-food').value
        },
        weight: {
            food: document.getElementById('default-weight-food').value
        }
    };
    
    saveSettings(settings);
    showAlert('success', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    setTimeout(() => {
        showScreen('main-menu');
    }, 500);
});

function showAlert(type, message) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

async function editRecord(type, recordId) {
    const endpoint = type === 'asthma' ? `/api/asthma` : (type === 'defecation' ? `/api/defecation` : `/api/weight`);
    
    try {
        const response = await fetch(endpoint);
        const data = await response.json();
        const items = type === 'asthma' ? data.attacks : (type === 'defecation' ? data.defecations : data.weights);
        const record = items.find(item => item._id === recordId);
        
        if (!record) {
            showAlert('error', '–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        // Parse date and time
        const [datePart, timePart] = record.date_time.split(' ');
        const [year, month, day] = datePart.split('-');
        const [hour, minute] = timePart.split(':');
        
        if (type === 'asthma') {
            document.getElementById('asthma-record-id').value = recordId;
            document.getElementById('asthma-date').value = datePart;
            document.getElementById('asthma-time').value = timePart;
            document.getElementById('asthma-duration').value = record.duration;
            document.getElementById('asthma-reason').value = record.reason;
            document.getElementById('asthma-inhalation').value = record.inhalation === '–î–∞' ? 'true' : 'false';
            document.getElementById('asthma-comment').value = record.comment && record.comment !== '-' ? record.comment : '';
            document.getElementById('asthma-submit-btn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
            showScreen('asthma-form');
        } else if (type === 'defecation') {
            document.getElementById('defecation-record-id').value = recordId;
            document.getElementById('defecation-date').value = datePart;
            document.getElementById('defecation-time').value = timePart;
            document.getElementById('defecation-stool-type').value = record.stool_type;
            document.getElementById('defecation-color').value = record.color || '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π';
            document.getElementById('defecation-food').value = record.food && record.food !== '-' ? record.food : 'Royal Canin Fibre Response';
            document.getElementById('defecation-comment').value = record.comment && record.comment !== '-' ? record.comment : '';
            document.getElementById('defecation-submit-btn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
            showScreen('defecation-form');
        } else if (type === 'weight') {
            document.getElementById('weight-record-id').value = recordId;
            document.getElementById('weight-date').value = datePart;
            document.getElementById('weight-time').value = timePart;
            document.getElementById('weight-value').value = record.weight;
            document.getElementById('weight-food').value = record.food && record.food !== '-' ? record.food : 'Royal Canin Fibre Response';
            document.getElementById('weight-comment').value = record.comment && record.comment !== '-' ? record.comment : '';
            document.getElementById('weight-submit-btn').textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
            showScreen('weight-form');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–ø–∏—Å–∏');
        console.error('Error:', error);
    }
}

async function deleteRecord(type, recordId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
        return;
    }
    
    const endpoint = `/api/${type}/${recordId}`;
    
    try {
        const response = await fetch(endpoint, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const result = await response.json();
        if (response.ok) {
            showAlert('success', result.message || '–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
            // Reload history
            const currentTab = document.querySelector('.tab-btn.active');
            if (currentTab.textContent.includes('–∞—Å—Ç–º—ã')) {
                showHistoryTab('asthma');
            } else if (currentTab.textContent.includes('–î–µ—Ñ–µ–∫–∞—Ü–∏–∏')) {
                showHistoryTab('defecation');
            } else if (currentTab.textContent.includes('–í–µ—Å')) {
                showHistoryTab('weight');
            }
        } else {
            showAlert('error', result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
    } catch (error) {
        showAlert('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        console.error('Error:', error);
    }
}
</script>
{% endblock %}
